<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Eventverleih</title>
  <link rel="icon" type="image/png" href="image/Logo.png" />

  <style>
    :root{
      --vh: 1vh;
      --cart-width: 360px;
      --title-height: 70px;

      --font-base: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      --bg:#ffffff;
      --text:#1f2933;
      --title-shadow: 0 8px 24px rgba(0,0,0,.12);
    }

    html, body{
      margin:0;
      padding:0;
      height:100%;
      background:var(--bg);
      color:var(--text);
      font-family:var(--font-base);
      overflow:hidden; /* Page-Scroll aus */
      -webkit-text-size-adjust:100%;
    }
    *, *::before, *::after{ box-sizing:border-box; }

    .slot{ width:100%; border:0; outline:0; background:transparent; }

    /* Cookie Overlay */
    #cookieOverlay{
      position:fixed;
      inset:0;
      z-index:9999;
      display:none;
      background:transparent;
    }
    #cookieOverlay.is-visible{ display:block; }

    /* Titel */
    #title{
      position:fixed;
      top:0; left:0; right:0;
      height:var(--title-height);
      z-index:2000;
      background:#fff;
      box-shadow:none;
    }
    #title.is-scrolled{ box-shadow:var(--title-shadow); }

    /* Bühne */
    #stage{
      position:fixed;
      top:var(--title-height);
      left:0; right:0;
      height:calc((var(--vh) * 100) - var(--title-height));
      overflow:hidden;
      touch-action:none; /* Mobile: wir übernehmen Swipe */
    }

    /* Panels */
    #panels{
      height:200%;
      transform:translateY(0);
      transition:transform .35s ease;
      will-change:transform;
    }

    /* Desktop: Head/Shop dürfen scrollen (wie vorher) */
    #head, #shop{
      height:calc((var(--vh) * 100) - var(--title-height));
      overflow:auto;
      overscroll-behavior:contain;
      -webkit-overflow-scrolling:touch;
      scrollbar-width:none;
    }
    #head::-webkit-scrollbar,
    #shop::-webkit-scrollbar{ width:0; height:0; }

    /* Shop Platz für Cart (Desktop) */
    #shop{
      width:calc(100% - var(--cart-width));
      margin-right:var(--cart-width);
    }

    /* Cart */
    #cart{
      position:fixed;
      top:0; right:0;
      width:var(--cart-width);
      height:calc(var(--vh) * 100);
      z-index:50;
      background:transparent;
      pointer-events:none;
      transform:translateX(100%);
      transition:transform .22s ease;
    }

    @media (max-width: 900px){
      :root{ --cart-width:0px; }
      #shop{ width:100%; margin-right:0; }
      /* Mobile: Head/Shop NICHT scrollen */
      #head, #shop{ overflow:hidden !important; }
      #panels{ transition:transform .28s ease; }
    }
  </style>

  <script>
    (function(){
      function setVH(){
        const h = (window.visualViewport && window.visualViewport.height)
          ? window.visualViewport.height
          : window.innerHeight;
        document.documentElement.style.setProperty('--vh', (h * 0.01) + 'px');
      }
      setVH();
      window.addEventListener('resize', setVH);
      window.addEventListener('orientationchange', setVH);
      if(window.visualViewport){
        window.visualViewport.addEventListener('resize', setVH);
        window.visualViewport.addEventListener('scroll', setVH);
      }
    })();
  </script>
</head>

<body>
  <div id="cookieOverlay" class="slot" data-src="backend/cookie.html"></div>
  <header id="title" class="slot" data-src="backend/titel.html"></header>

  <div id="stage">
    <div id="panels">
      <section id="head" class="slot" data-src="backend/head.html"></section>
      <main id="shop" class="slot" data-src="backend/shop.html"></main>
    </div>
  </div>

  <aside id="cart" class="slot" data-src="backend/cart.html"></aside>

  <script>
    (function(){
      const COOKIE_KEY = "cookiesAccepted_v1";

      function isMobile(){
        return window.matchMedia && window.matchMedia("(max-width: 900px)").matches;
      }

      // von cookie.html aufrufbar
      window.acceptCookies = function(){
        try { localStorage.setItem(COOKIE_KEY, "1"); } catch(e) {}
        const ov = document.getElementById("cookieOverlay");
        if(ov) ov.classList.remove("is-visible");
      };

      // Cart Steuerung
      window.openCart = function(){
        const el = document.getElementById("cart");
        if(!el) return;
        el.style.pointerEvents = "auto";
        el.style.transform = "translateX(0)";
      };
      window.closeCart = function(){
        const el = document.getElementById("cart");
        if(!el) return;
        el.style.pointerEvents = "none";
        el.style.transform = "translateX(100%)";
      };

      async function loadInto(el, url){
        const res = await fetch(url, { cache:"no-store" });
        if(!res.ok) throw new Error(url + " -> " + res.status);
        const html = await res.text();
        el.innerHTML = html;

        // scripts ausführen
        const scripts = Array.from(el.querySelectorAll("script"));
        for(const s of scripts){
          const ns = document.createElement("script");
          for(const attr of s.attributes){ ns.setAttribute(attr.name, attr.value); }
          ns.text = s.text || "";
          s.parentNode.replaceChild(ns, s);
        }
      }

      function cookieVisible(){
        const ov = document.getElementById("cookieOverlay");
        return !!(ov && ov.classList.contains("is-visible"));
      }

      function setupTitleShadow(getScrollTop){
        const title = document.getElementById("title");
        if(!title) return;
        const update = () => {
          const top = getScrollTop();
          if(top > 0) title.classList.add("is-scrolled");
          else title.classList.remove("is-scrolled");
        };
        update();
        return update;
      }

      function setupSwitching(){
        const stage  = document.getElementById("stage");
        const panels = document.getElementById("panels");
        const head   = document.getElementById("head");
        const shop   = document.getElementById("shop");
        if(!stage || !panels || !head || !shop) return;

        window.__view = "head";
        let locked = false;

        const panelH = () => stage.clientHeight || window.innerHeight;

        function setPos(px, animate){
          if(!animate) panels.style.transition = "none";
          panels.style.transform = "translateY(" + px + "px)";
          if(!animate){
            requestAnimationFrame(() => panels.style.transition = "transform .28s ease");
          }
        }

        function goHead(){
          if(locked || window.__view === "head" || cookieVisible()) return;
          locked = true;
          window.__view = "head";
          setPos(0, true);
          setTimeout(()=> locked = false, 320);
        }

        function goShop(){
          if(locked || window.__view === "shop" || cookieVisible()) return;
          locked = true;
          window.__view = "shop";
          setPos(-panelH(), true);
          setTimeout(()=> locked = false, 320);
        }

        // Exports für Head/Shop HTML
        window.goHead = goHead;
        window.goShop = goShop;

        if(!isMobile()){
          // Desktop: Shadow hängt am aktiven Container-Scroll
          const updateShadow = setupTitleShadow(() => (window.__view === "shop" ? shop.scrollTop : head.scrollTop));
          head.addEventListener("scroll", () => updateShadow && updateShadow(), { passive:true });
          shop.addEventListener("scroll", () => updateShadow && updateShadow(), { passive:true });

          const atBottom = (el) => el.scrollTop + el.clientHeight >= el.scrollHeight - 2;
          const atTop    = (el) => el.scrollTop <= 0;

          head.addEventListener("wheel", (e) => {
            if(cookieVisible()) return;
            if(e.deltaY > 0 && atBottom(head)){
              e.preventDefault();
              goShop();
            }
          }, { passive:false });

          shop.addEventListener("wheel", (e) => {
            if(cookieVisible()) return;
            if(e.deltaY < 0 && atTop(shop)){
              e.preventDefault();
              goHead();
            }
          }, { passive:false });

          return;
        }

        // Mobile: Swipe/Pull mit 20% Schwelle
        const THR = 0.20;

        // Mobile: kein inneres Scroll -> Titelshadow immer aus
        setupTitleShadow(() => 0);

        let startY = 0, startX = 0, lastY = 0;
        let dragging = false;

        function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }

        stage.addEventListener("touchstart", (e) => {
          if(cookieVisible() || locked) return;
          const t = e.touches[0];
          startY = t.clientY;
          startX = t.clientX;
          lastY  = startY;
          dragging = true;
          panels.style.transition = "none";
        }, { passive:true });

        stage.addEventListener("touchmove", (e) => {
          if(!dragging || cookieVisible()) return;

          const t = e.touches[0];
          const dy = t.clientY - startY;
          const dx = t.clientX - startX;

          // Horizontal? dann nicht übernehmen
          if(Math.abs(dx) > Math.abs(dy) * 1.2) return;

          e.preventDefault();
          lastY = t.clientY;

          const h = panelH();
          const base = (window.__view === "shop") ? -h : 0;
          const y = clamp(base + dy, -h - 60, 60);
          setPos(y, false);
        }, { passive:false });

        stage.addEventListener("touchend", () => {
          if(!dragging || cookieVisible()) return;
          dragging = false;

          panels.style.transition = "transform .28s ease";

          const dy = lastY - startY;
          const h  = panelH();
          const thrPx = h * THR;

          if(window.__view === "head"){
            if(dy < -thrPx) goShop();
            else setPos(0, true);
          } else {
            if(dy > thrPx) goHead();
            else setPos(-h, true);
          }
        }, { passive:true });

        window.addEventListener("resize", () => {
          if(window.__view === "shop") setPos(-panelH(), true);
          else setPos(0, true);
        }, { passive:true });
      }

      async function boot(){
        const slots = Array.from(document.querySelectorAll("[data-src]"));

        // alles außer cookieOverlay zuerst
        const normal = slots.filter(el => el.id !== "cookieOverlay");
        await Promise.all(normal.map(el => loadInto(el, el.dataset.src)));

        // Cookie ggf. danach anzeigen
        let accepted = false;
        try { accepted = localStorage.getItem(COOKIE_KEY) === "1"; } catch(e) {}
        if(!accepted){
          const overlay = document.getElementById("cookieOverlay");
          overlay.classList.add("is-visible");
          await loadInto(overlay, overlay.dataset.src);
        }

        setupSwitching();
      }

      boot().catch(err => {
        console.error(err);
        // minimale Debug-Hilfe: falls fetch scheitert, zeigen wir wenigstens etwas
        document.body.style.background = "#fff";
      });
    })();
  </script>
</body>
</html>
