<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Eventverleih</title>
  <link rel="icon" type="image/png" href="image/Logo.png" />

  <style>
    :root{
      --vh: 1vh; /* echte Viewport-Höhe (Mobile-Fix) */
      --cart-width: 360px;
      --title-height: 70px;

      --font-base: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;

      --bg: #ffffff;
      --text: #1f2933;
      --muted: #6b7280;
      --primary: #1f4fa3;

      --card: #f8f9fb;
      --radius: 14px;
      --shadow: 0 12px 40px rgba(0,0,0,.18);

      --title-shadow: 0 8px 24px rgba(0,0,0,.12);
    }

    html, body{
      margin:0;
      padding:0;
      height:100%;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-base);
      overflow:hidden; /* Page-Scroll komplett aus */
      -webkit-text-size-adjust: 100%;
      text-rendering: optimizeLegibility;
    }

    *, *::before, *::after{ box-sizing: border-box; }

    /* Safety: niemals horizontal scrollen (verhindert Chrome-Scrollbar-Gutter) */
    body{ overflow-x:hidden; }
    #stage, #panels, #head, #shop, #foot{ overflow-x:hidden; }


    .slot{
      width:100%;
      border:0;
      outline:0;
      background:transparent;
    }

    /* Cookie-Overlay */
    #cookieOverlay{
      position:fixed;
      inset:0;
      z-index:9999;
      display:none;
      background:transparent;
    }
    #cookieOverlay.is-visible{ display:block; }

    /* TITEL */
    #title{
      position:fixed;
      top:0; left:0; right:0;
      z-index:2000;
      height: var(--title-height);
      background:#fff;
      display:block;
      box-shadow:none;
    }
    #title.is-scrolled{
      box-shadow: var(--title-shadow);
    }

    /* Bühne unter der Titel-Leiste */
    #stage{
      position:fixed;
      top: var(--title-height);
      left:0; right:0;
      height: calc((var(--vh) * 100) - var(--title-height));
      overflow:hidden;
    }

    /* Panels Head + Shop + Foot untereinander */
    #panels{
      height: 300%;
      transform: translateY(0);
      transition: transform .35s ease;
      will-change: transform;
    }

    /* Head / Shop / Foot: nur intern scrollen (NUR vertikal; verhindert 10–15px Scroll-Gutter unten) */
    #head, #shop{
      height: calc((var(--vh) * 100) - var(--title-height));
      overflow-y: auto;      /* nur vertikal */
      overflow-x: hidden;    /* verhindert horizontale Scroll-Reserve */
      overscroll-behavior-y: contain;
      -webkit-overflow-scrolling: touch;
    }

    /* Foot: NIE selber scrollen (sonst entsteht unten häufig ein 10–15px Scroll-Gutter).
       Scroll (falls nötig) passiert NUR innen in backend/foot.html. */
    #foot{
      height: calc((var(--vh) * 100) - var(--title-height));
      overflow: hidden !important;
    }
    #head, #shop, #foot{ scrollbar-width: none; }
    #head::-webkit-scrollbar,
    #shop::-webkit-scrollbar,
    #foot::-webkit-scrollbar{
      width:0;
      height:0;
    }

    /* Shop: Platz für Cart rechts (Desktop) */
    #shop{
      width:calc(100% - var(--cart-width));
      margin-right:var(--cart-width);
    }

    /* Cart */
    #cart{
      position:fixed;
      top:0;
      right:0;
      height: calc(var(--vh) * 100);
      width:var(--cart-width);
      z-index:50;
      background:transparent;
      pointer-events:none;
      transform: translateX(100%);
      transition: transform .22s ease;
    }

    @media (max-width: 900px){
      :root{ --cart-width: 0px; }
      #cart{ transform:none; }
      #shop{ width:100%; margin-right:0; }
    }
  </style>

  <script>
    // Viewport-Fix: --vh entspricht der echten sichtbaren Höhe (Mobile Browserleisten)
    (function(){
      function setVH(){
        const h = (window.visualViewport && window.visualViewport.height)
          ? window.visualViewport.height
          : window.innerHeight;
        document.documentElement.style.setProperty('--vh', (h * 0.01) + 'px');
      }
      setVH();
      window.addEventListener('resize', setVH);
      window.addEventListener('orientationchange', setVH);
      if (window.visualViewport){
        window.visualViewport.addEventListener('resize', setVH);
        window.visualViewport.addEventListener('scroll', setVH);
      }
    })();
  </script>

</head>

<body>
  <!-- 1) Cookies -->
  <div id="cookieOverlay" class="slot" data-src="backend/cookie.html"></div>

  <!-- 2) Titel -->
  <header id="title" class="slot" data-src="backend/titel.html"></header>

  <!-- 3/4/5) Stage: Head + Shop + Foot (kein Page-Scroll) -->
  <div id="stage">
    <div id="panels">
      <section id="head" class="slot" data-src="backend/head.html"></section>
      <main id="shop" class="slot" data-src="backend/shop.html"></main>
      <footer id="foot" class="slot" data-src="backend/foot.html"></footer>
    </div>
  </div>

  <!-- 6) Cart -->
  <aside id="cart" class="slot" data-src="backend/cart.html"></aside>

  <script>
    (function(){
      const COOKIE_KEY = "cookiesAccepted_v1";

      /* von cookie.html aufrufbar */
      window.acceptCookies = function(){
        try { localStorage.setItem(COOKIE_KEY, "1"); } catch(e) {}
        document.getElementById("cookieOverlay")?.classList.remove("is-visible");
      };

      /* Cart-Steuerung */
      window.openCart = function(){
        const el = document.getElementById("cart");
        if(!el) return;
        el.style.pointerEvents = "auto";
        el.style.transform = "translateX(0)";
      };

      window.closeCart = function(){
        const el = document.getElementById("cart");
        if(!el) return;
        el.style.pointerEvents = "none";
        el.style.transform = "translateX(100%)";
      };

      async function loadInto(el, url){
        const res = await fetch(url, { cache: "no-store" });
        if(!res.ok) throw new Error(url + " -> " + res.status);
        const html = await res.text();

        el.innerHTML = html;

        /* Scripts aus geladenem HTML ausführen */
        const scripts = Array.from(el.querySelectorAll("script"));
        for(const s of scripts){
          const ns = document.createElement("script");
          for(const attr of s.attributes){
            ns.setAttribute(attr.name, attr.value);
          }
          ns.text = s.text || "";
          s.parentNode.replaceChild(ns, s);
        }
      }

      function setupTitleShadow(getScrollEl){
        const title = document.getElementById("title");
        if(!title) return;

        const update = () => {
          const el = getScrollEl();
          const top = el ? el.scrollTop : 0;
          if(top > 0) title.classList.add("is-scrolled");
          else title.classList.remove("is-scrolled");
        };

        window.__updateTitleShadow = update;
        update();
      }

      function setupHeadShopFootScrollSwitch(){
        const head   = document.getElementById("head");
        const shop   = document.getElementById("shop");
        const foot   = document.getElementById("foot");
        const panels = document.getElementById("panels");
        if(!head || !shop || !foot || !panels) return;

        // WICHTIG:
        // Wenn head/shop/foot intern eigene Scroll-Container haben, müssen wir DIE nehmen.
        // Fallback ist jeweils der Container selbst.
        const getHeadScrollEl = () => head.querySelector(".team-scroll") || head;
        const getShopScrollEl = () => shop.querySelector(".shop-scroll") || shop;
        const getFootScrollEl = () => foot.querySelector(".foot-scroll") || foot;

        window.__view = "head";  // "head" | "shop" | "foot"
        let locked = false;

        const cookieVisible = () => {
          const ov = document.getElementById("cookieOverlay");
          return !!(ov && ov.classList.contains("is-visible"));
        };

        const atBottom = (el) => el.scrollTop + el.clientHeight >= el.scrollHeight - 2;
        const atTop    = (el) => el.scrollTop <= 0;

        const setView = (v) => {
          if(locked || window.__view === v) return;
          locked = true;
          window.__view = v;

          // 3 Panels => 0%, -33.333%, -66.666%
          if(v === "head") panels.style.transform = "translateY(0)";
          if(v === "shop") panels.style.transform = "translateY(-33.3333%)";
          if(v === "foot") panels.style.transform = "translateY(-66.6666%)";

          window.__updateTitleShadow && window.__updateTitleShadow();
          setTimeout(()=> locked = false, 380);
        };

        const goShop = () => setView("shop");
        const goHead = () => setView("head");
        const goFoot = () => setView("foot");

        // Für Head/Shop/Foot-HTML: damit deine Impuls-Skripte wirklich wechseln können
        window.goShop = goShop;
        window.goHead = goHead;
        window.goFoot = goFoot;

        // Titel-Schatten an das gerade aktive Scroll-Element koppeln
        setupTitleShadow(() => {
          if(window.__view === "shop") return getShopScrollEl();
          if(window.__view === "foot") return getFootScrollEl();
          return getHeadScrollEl();
        });

        // Scroll-Listener für Shadow (auf allen Scroll-Elementen, falls intern)
        const bindScrollShadow = () => {
          const hs = getHeadScrollEl();
          const ss = getShopScrollEl();
          const fs = getFootScrollEl();
          if(hs) hs.addEventListener("scroll", () => window.__updateTitleShadow && window.__updateTitleShadow(), { passive:true });
          if(ss) ss.addEventListener("scroll", () => window.__updateTitleShadow && window.__updateTitleShadow(), { passive:true });
          if(fs) fs.addEventListener("scroll", () => window.__updateTitleShadow && window.__updateTitleShadow(), { passive:true });
        };

        // Wheel-Impulse: auf den echten Scrollflächen!
        const bindWheel = () => {
          const hs = getHeadScrollEl();
          const ss = getShopScrollEl();
          const fs = getFootScrollEl();

          // Head -> Shop
          hs.addEventListener("wheel", (e) => {
            if(cookieVisible()) return;
            if(e.deltaY > 0 && atBottom(hs)){
              e.preventDefault();
              goShop();
            }
          }, { passive:false });

          // Shop -> Foot / Shop -> Head
          ss.addEventListener("wheel", (e) => {
            if(cookieVisible()) return;

            if(e.deltaY > 0 && atBottom(ss)){
              e.preventDefault();
              goFoot();
              return;
            }

            if(e.deltaY < 0 && atTop(ss)){
              e.preventDefault();
              goHead();
            }
          }, { passive:false });

          // Foot -> Shop
          fs.addEventListener("wheel", (e) => {
            if(cookieVisible()) return;
            if(e.deltaY < 0 && atTop(fs)){
              e.preventDefault();
              goShop();
            }
          }, { passive:false });
        };

        // Keyboard-Impulse (optional)
        window.addEventListener("keydown", (e) => {
          if(cookieVisible()) return;

          const downKeys = ["ArrowDown","PageDown"," "];
          const upKeys   = ["ArrowUp","PageUp"];

          const hs = getHeadScrollEl();
          const ss = getShopScrollEl();
          const fs = getFootScrollEl();

          if(window.__view === "head" && downKeys.includes(e.key) && atBottom(hs)){
            e.preventDefault(); goShop();
          }
          if(window.__view === "shop"){
            if(downKeys.includes(e.key) && atBottom(ss)){ e.preventDefault(); goFoot(); }
            if(upKeys.includes(e.key) && atTop(ss)){ e.preventDefault(); goHead(); }
          }
          if(window.__view === "foot" && upKeys.includes(e.key) && atTop(fs)){
            e.preventDefault(); goShop();
          }
        }, { passive:false });

        // Nach Laden (und auch nach Resize) sicherstellen, dass wir die richtigen Scroll-Elemente erwischen
        const lateBind = () => {
          bindScrollShadow();
          bindWheel();
          window.__updateTitleShadow && window.__updateTitleShadow();
        };

        // Einmal direkt und einmal kurz danach (falls DOM noch nachzieht)
        lateBind();
        setTimeout(lateBind, 120);
        window.addEventListener("resize", () => setTimeout(lateBind, 60), { passive:true });
      }

      async function boot(){
        const slots = Array.from(document.querySelectorAll("[data-src]"));

        let accepted = false;
        try { accepted = localStorage.getItem(COOKIE_KEY) === "1"; } catch(e) {}

        /* Titel / Head / Shop / Foot / Cart immer laden */
        const normalSlots = slots.filter(el => el.id !== "cookieOverlay");
        await Promise.all(normalSlots.map(el => loadInto(el, el.dataset.src)));

        /* Cookie nur bei Bedarf */
        if(!accepted){
          const overlay = document.getElementById("cookieOverlay");
          overlay.classList.add("is-visible");
          await loadInto(overlay, overlay.dataset.src);
        }

        setupHeadShopFootScrollSwitch();
      }

      boot().catch(err => console.error(err));
    })();

    // Mobile Swipe-Support (Head/Shop/Foot wechseln per Wischgeste)
    (function(){
      let touchY0 = 0;
      let touchT0 = 0;

      const THRESHOLD = 50; // px
      const MAX_DT = 700;   // ms

      const getHeadScrollEl = () => {
        const head = document.getElementById("head");
        return head ? (head.querySelector(".team-scroll") || head) : null;
      };

      const getShopScrollEl = () => {
        const shop = document.getElementById("shop");
        return shop ? (shop.querySelector(".shop-scroll") || shop) : null;
      };

      const getFootScrollEl = () => {
        const foot = document.getElementById("foot");
        return foot ? (foot.querySelector(".foot-scroll") || foot) : null;
      };

      const cookieVisible = () => {
        const ov = document.getElementById("cookieOverlay");
        return !!(ov && ov.classList.contains("is-visible"));
      };

      const atBottom = (el) => !!el && (el.scrollTop + el.clientHeight >= el.scrollHeight - 2);
      const atTop    = (el) => !!el && (el.scrollTop <= 0);

      window.addEventListener("touchstart", (e) => {
        if(cookieVisible()) return;
        if(!e.touches || !e.touches.length) return;
        touchY0 = e.touches[0].clientY;
        touchT0 = Date.now();
      }, { passive:true });

      window.addEventListener("touchend", (e) => {
        if(cookieVisible()) return;

        const goShop = window.goShop;
        const goHead = window.goHead;
        const goFoot = window.goFoot;
        if(typeof goShop !== "function" || typeof goHead !== "function" || typeof goFoot !== "function") return;

        const dt = Date.now() - touchT0;
        if(dt > MAX_DT) return;

        const t = (e.changedTouches && e.changedTouches.length) ? e.changedTouches[0] : null;
        if(!t) return;

        const dy = t.clientY - touchY0;

        const view   = window.__view || "head";
        const headEl = getHeadScrollEl();
        const shopEl = getShopScrollEl();
        const footEl = getFootScrollEl();

        // Swipe up -> weiter (nach unten)
        if(dy < -THRESHOLD){
          if(view === "head" && atBottom(headEl)) { goShop(); return; }
          if(view === "shop" && atBottom(shopEl)) { goFoot(); return; }
          return;
        }

        // Swipe down -> zurück (nach oben)
        if(dy > THRESHOLD){
          if(view === "foot" && atTop(footEl)) { goShop(); return; }
          if(view === "shop" && atTop(shopEl)) { goHead(); return; }
        }
      }, { passive:true });

    })();
  </script>
</body>
</html>
