<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Eventverleih</title>
  <link rel="icon" type="image/png" href="image/Logo.png" />

  <style>
    :root{
      --cart-width: 360px;
      --title-height: 70px;

      --font-base: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;

      --bg: #ffffff;
      --text: #1f2933;
      --muted: #6b7280;
      --primary: #1f4fa3;

      --radius: 14px;
      --title-shadow: 0 8px 24px rgba(0,0,0,.12);
    }

    html, body{
      margin:0;
      padding:0;
      height:100%;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-base);
      overflow:hidden; /* WICHTIG: kein Page-Scroll */
      -webkit-text-size-adjust: 100%;
      text-rendering: optimizeLegibility;
    }

    *, *::before, *::after{ box-sizing: border-box; }

    .slot{
      width:100%;
      border:0;
      outline:0;
      background:transparent;
    }

    /* Cookie-Overlay */
    #cookieOverlay{
      position:fixed;
      inset:0;
      z-index:9999;
      display:none;
      background:transparent;
    }
    #cookieOverlay.is-visible{ display:block; }

    /* Titel */
    #title{
      position:fixed;
      top:0; left:0; right:0;
      z-index:2000;
      height: var(--title-height);
      background:#fff;
      display:block;
      box-shadow:none;
    }
    #title.is-scrolled{
      box-shadow: var(--title-shadow);
    }

    /* Bühne */
    #stage{
      position:fixed;
      top: var(--title-height);
      left:0; right:0;
      height: calc(100vh - var(--title-height));
      overflow:hidden;
    }

    /* Panels (Head + Shop) */
    #panels{
      height: 200%;
      transform: translateY(0);
      transition: transform .35s ease;
      will-change: transform;
    }

    /* WICHTIG: NICHT im Index scrollen. Scroll ist in head.html / shop.html */
    #head, #shop{
      height: calc(100vh - var(--title-height));
      overflow:hidden;
      position: relative;
    }

    /* Shop: Platz für Cart rechts (Desktop) */
    #shop{
      width:calc(100% - var(--cart-width));
      margin-right:var(--cart-width);
    }

    /* Cart */
    #cart{
      position:fixed;
      top:0;
      right:0;
      height:100vh;
      width:var(--cart-width);
      z-index:50;
      background:transparent;
      pointer-events:none;
      transform: translateX(100%);
      transition: transform .22s ease;
    }

    @media (max-width: 900px){
      :root{ --cart-width: 0px; }
      #cart{ transform:none; }
      #shop{ width:100%; margin-right:0; }
    }

    /* Debug / Fehleranzeige beim Laden */
    .load-error{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 24px;
      color: rgba(15,23,42,0.75);
      text-align:center;
    }
    .load-error > div{
      max-width: 860px;
      background: rgba(255,255,255,0.92);
      border: 1px solid rgba(15,23,42,0.12);
      border-radius: 16px;
      padding: 18px 18px 16px;
    }
    .load-error b{ color:#0f172a; }
    .load-error code{
      background: rgba(15,23,42,0.06);
      padding: 2px 6px;
      border-radius: 8px;
    }
  </style>
</head>

<body>
  <!-- 1) Cookies -->
  <div id="cookieOverlay" class="slot" data-src="backend/cookie.html"></div>

  <!-- 2) Titel -->
  <header id="title" class="slot" data-src="backend/titel.html"></header>

  <!-- 3/4) Stage -->
  <div id="stage">
    <div id="panels">
      <section id="head" class="slot" data-src="backend/head.html"></section>
      <main id="shop" class="slot" data-src="backend/shop.html"></main>
    </div>
  </div>

  <!-- 5) Cart -->
  <aside id="cart" class="slot" data-src="backend/cart.html"></aside>

  <script>
    (function(){
      const COOKIE_KEY = "cookiesAccepted_v1";

      /* von cookie.html aufrufbar */
      window.acceptCookies = function(){
        try { localStorage.setItem(COOKIE_KEY, "1"); } catch(e) {}
        document.getElementById("cookieOverlay")?.classList.remove("is-visible");
      };

      /* Cart-Steuerung */
      window.openCart = function(){
        const el = document.getElementById("cart");
        if(!el) return;
        el.style.pointerEvents = "auto";
        el.style.transform = "translateX(0)";
      };

      window.closeCart = function(){
        const el = document.getElementById("cart");
        if(!el) return;
        el.style.pointerEvents = "none";
        el.style.transform = "translateX(100%)";
      };

      async function loadInto(el, url){
        const res = await fetch(url, { cache: "no-store" });
        if(!res.ok) throw new Error(url + " -> " + res.status);

        const html = await res.text();
        el.innerHTML = html;

        // Scripts aus geladenem HTML ausführen
        const scripts = Array.from(el.querySelectorAll("script"));
        for(const s of scripts){
          const ns = document.createElement("script");
          for(const attr of s.attributes){
            ns.setAttribute(attr.name, attr.value);
          }
          ns.text = s.text || "";
          s.parentNode.replaceChild(ns, s);
        }
      }

      function setupPanelSwitch(){
        const panels = document.getElementById("panels");
        if(!panels) return;

        window.__view = "head"; // "head" | "shop"
        let locked = false;

        const cookieVisible = () => {
          const ov = document.getElementById("cookieOverlay");
          return !!(ov && ov.classList.contains("is-visible"));
        };

        const goShop = () => {
          if(cookieVisible()) return;
          if(locked || window.__view === "shop") return;
          locked = true;
          window.__view = "shop";
          panels.style.transform = "translateY(-100%)";
          window.__updateTitleShadow && window.__updateTitleShadow();
          setTimeout(()=> locked = false, 380);
        };

        const goHead = () => {
          if(cookieVisible()) return;
          if(locked || window.__view === "head") return;
          locked = true;
          window.__view = "head";
          panels.style.transform = "translateY(0)";
          window.__updateTitleShadow && window.__updateTitleShadow();
          setTimeout(()=> locked = false, 380);
        };

        window.goShop = goShop;
        window.goHead = goHead;
      }

      function setupTitleShadow(){
        const title = document.getElementById("title");
        const head  = document.getElementById("head");
        const shop  = document.getElementById("shop");
        if(!title || !head || !shop) return;

        // Wir versuchen den "inneren" Scrollcontainer zu finden:
        // head.html: #teamScroll, shop.html: #shopScroll (falls vorhanden)
        const getActiveInnerScroll = () => {
          const v = window.__view || "head";
          if (v === "shop") return document.getElementById("shopScroll");
          return document.getElementById("teamScroll");
        };

        const update = () => {
          const sc = getActiveInnerScroll();
          const has = sc ? (sc.scrollTop > 0) : false;
          title.classList.toggle("is-scrolled", !!has);
        };

        // Delegiert: wir hören global und aktualisieren bei Scroll in den inneren Containern
        window.addEventListener("scroll", update, { passive:true, capture:true });
        window.addEventListener("resize", update, { passive:true });

        window.__updateTitleShadow = update;
        update();
      }

      function showLoadError(el, url, err){
        el.innerHTML = `
          <div class="load-error">
            <div>
              <div style="font-size:18px; font-weight:900; margin-bottom:8px;">Inhalt konnte nicht geladen werden</div>
              <div style="margin-bottom:10px;">
                Datei: <b><code>${escapeHtml(url)}</code></b>
              </div>
              <div style="opacity:.85;">
                ${escapeHtml(String(err && err.message ? err.message : err))}
              </div>
            </div>
          </div>
        `;
      }

      function escapeHtml(s){
        return String(s)
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      async function boot(){
        const slots = Array.from(document.querySelectorAll("[data-src]"));

        let accepted = false;
        try { accepted = localStorage.getItem(COOKIE_KEY) === "1"; } catch(e) {}

        // 1) Erst normale Slots laden (ohne CookieOverlay) – ABER robust (allSettled)
        const normalSlots = slots.filter(el => el.id !== "cookieOverlay");

        const results = await Promise.allSettled(
          normalSlots.map(async (el) => {
            const url = el.dataset.src;
            try{
              await loadInto(el, url);
              return { ok:true, el, url };
            }catch(err){
              showLoadError(el, url, err);
              return { ok:false, el, url, err };
            }
          })
        );

        // 2) Cookie nur bei Bedarf laden
        if(!accepted){
          const overlay = document.getElementById("cookieOverlay");
          overlay.classList.add("is-visible");
          try{
            await loadInto(overlay, overlay.dataset.src);
          }catch(err){
            showLoadError(overlay, overlay.dataset.src, err);
          }
        }

        // 3) Switch + Shadow
        setupPanelSwitch();
        setupTitleShadow();

        // Optional: wenn Shop nicht geladen wurde, kann natürlich auch kein Platzhalter erscheinen
        // -> du siehst dann jetzt aber eine klare Fehlermeldung IM Shop-Panel.
        results.forEach(r => {
          if (r.status === "fulfilled" && r.value && r.value.ok === false){
            console.warn("Load failed:", r.value.url, r.value.err);
          }
        });
      }

      boot().catch(err => console.error(err));
    })();
  </script>
</body>
</html>
