<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Eventverleih</title>
  <link rel="icon" type="image/png" href="image/Logo.png" />

  <style>
    :root{
      --cart-width: 360px;
      --title-height: 70px;

      --font-base: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;

      --bg: #ffffff;
      --radius: 18px;
      --shadow-soft: 0 12px 34px rgba(0,0,0,.14);
      --shadow-header: 0 10px 26px rgba(0,0,0,.12);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--font-base);
      background:var(--bg);
      overflow:hidden; /* WICHTIG: Stage-Prinzip */
    }

    /* Cookie overlay */
    #cookieOverlay{
      position:fixed;
      inset:0;
      z-index:9999;
      display:none;
    }
    #cookieOverlay.is-visible{ display:block; }

    /* Titel: fix */
    #title{
      position:fixed;
      top:0; left:0; right:0;
      height:var(--title-height);
      z-index:1000;
      background:rgba(255,255,255,.92);
      backdrop-filter:saturate(140%) blur(10px);
      -webkit-backdrop-filter:saturate(140%) blur(10px);
      border-bottom:1px solid rgba(0,0,0,.06);
      box-shadow:none;
      transition: box-shadow .18s ease;
    }
    #title.is-scrolled{ box-shadow: var(--shadow-header); }

    /* Layout: Content + Cart */
    #layout{
      position:fixed;
      top: var(--title-height);
      left:0; right:0;
      height: calc(100vh - var(--title-height));
      display:flex;
      width:100%;
    }

    /* Stage (links): immer 1 Viewport hoch */
    #stage{
      flex:1;
      min-width:0;
      height: 100%;
      padding: 18px;
    }

    /* Panels: 2 Screens untereinander */
    #panels{
      width:100%;
      height:200%;
      transform: translateY(0%);
      transition: transform .38s ease;
    }
    #panels.is-shop{ transform: translateY(-50%); }

    /* Head / Shop Slots: jeweils genau 1 Screen hoch */
    .panel{
      height:50%;
      width:100%;
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: var(--shadow-soft);
      background:#d9dde3; /* Fallback bis geladen */
    }
    #shop{ background:#eef2f7; }

    /* Cart: rechts */
    #cart{
      width:var(--cart-width);
      flex:0 0 var(--cart-width);
      height: 100%;
      padding: 18px 18px 18px 0;
    }

    /* Mobile: Cart ausblenden */
    @media (max-width: 980px){
      #layout{ display:block; }
      #cart{ display:none; }
      #stage{ padding: 14px; }
      .panel{ border-radius: 16px; }
    }
  </style>
</head>

<body>
  <div id="cookieOverlay" data-src="backend/cookie.html"></div>
  <header id="title" data-src="backend/titel.html"></header>

  <div id="layout">
    <div id="stage" aria-label="Stage">
      <div id="panels">
        <section id="head" class="panel" data-src="backend/head.html" aria-label="Head"></section>
        <main id="shop" class="panel" data-src="backend/shop.html" aria-label="Shop"></main>
      </div>
    </div>

    <aside id="cart" data-src="backend/cart.html" aria-label="Warenkorb"></aside>
  </div>

  <script>
    (function(){
      "use strict";

      const panels = document.getElementById("panels");
      const headEl = document.getElementById("head");
      const shopEl = document.getElementById("shop");
      const titleEl = document.getElementById("title");

      let activePanel = "head"; // "head" | "shop"
      let switching = false;

      function setCookie(name, value, days){
        const d = new Date();
        d.setTime(d.getTime() + days*24*60*60*1000);
        document.cookie = name + "=" + encodeURIComponent(value) + ";expires=" + d.toUTCString() + ";path=/;SameSite=Lax";
      }
      function getCookie(name){
        const m = document.cookie.match(new RegExp("(^| )" + name + "=([^;]+)"));
        return m ? decodeURIComponent(m[2]) : null;
      }

      async function loadInto(el, url){
        try{
          const res = await fetch(url, { cache:"no-store" });
          if(!res.ok) throw new Error("HTTP " + res.status + " for " + url);
          el.innerHTML = await res.text();
        }catch(err){
          console.error("Load failed:", url, err);
        }
      }

      function getHeadScroller(){
        return headEl.querySelector(".team-scroll") || headEl;
      }
      function getShopScroller(){
        return shopEl.querySelector(".shop-scroll") || shopEl;
      }
      function getActiveScroller(){
        return (activePanel === "head") ? getHeadScroller() : getShopScroller();
      }

      function updateTitleShadow(){
        // Shadow wenn der aktive Scroller nicht am Top ist
        const sc = getActiveScroller();
        const y = sc ? sc.scrollTop : 0;
        if(y > 2) titleEl.classList.add("is-scrolled");
        else titleEl.classList.remove("is-scrolled");
      }

      function goShop(){
        if(switching || activePanel === "shop") return;
        switching = true;
        activePanel = "shop";
        panels.classList.add("is-shop");
        // nach Animation sicher entsperren
        setTimeout(() => { switching = false; updateTitleShadow(); }, 420);
      }

      function goHead(){
        if(switching || activePanel === "head") return;
        switching = true;
        activePanel = "head";
        panels.classList.remove("is-shop");
        setTimeout(() => { switching = false; updateTitleShadow(); }, 420);
      }

      // API für Links/Buttons in geladenen Komponenten
      window.goShop = goShop;
      window.goHead = goHead;

      // Overscroll-Trigger (nur Index steuert!)
      function atBottom(el){
        if(!el) return false;
        return (el.scrollTop + el.clientHeight) >= (el.scrollHeight - 2);
      }
      function atTop(el){
        if(!el) return true;
        return el.scrollTop <= 0;
      }

      function onWheel(e){
        if(switching) return;

        const sc = getActiveScroller();
        if(!sc) return;

        const dy = e.deltaY;

        // nur wenn der Nutzer wirklich am Rand ist
        if(activePanel === "head" && dy > 0 && atBottom(sc)){
          e.preventDefault();
          goShop();
          return;
        }
        if(activePanel === "shop" && dy < 0 && atTop(sc)){
          e.preventDefault();
          goHead();
          return;
        }
      }

      // Touch: swipe up/down am Rand
      let touchY0 = null;
      function onTouchStart(e){
        if(!e.touches || !e.touches.length) return;
        touchY0 = e.touches[0].clientY;
      }
      function onTouchMove(e){
        if(switching || touchY0 === null) return;
        if(!e.touches || !e.touches.length) return;

        const y = e.touches[0].clientY;
        const dy = y - touchY0; // >0 = down, <0 = up
        const sc = getActiveScroller();
        if(!sc) return;

        // nur mit spürbarem Swipe
        const threshold = 28;

        if(activePanel === "head" && dy < -threshold && atBottom(sc)){
          e.preventDefault();
          touchY0 = null;
          goShop();
          return;
        }
        if(activePanel === "shop" && dy > threshold && atTop(sc)){
          e.preventDefault();
          touchY0 = null;
          goHead();
          return;
        }
      }
      function onTouchEnd(){ touchY0 = null; }

      function bindScrollShadow(){
        const sc = getActiveScroller();
        if(!sc) return;
        sc.addEventListener("scroll", updateTitleShadow, { passive:true });
      }

      async function boot(){
        await Promise.all([
          loadInto(titleEl, titleEl.dataset.src),
          loadInto(headEl, headEl.dataset.src),
          loadInto(shopEl, shopEl.dataset.src),
          loadInto(document.getElementById("cart"), document.getElementById("cart").dataset.src),
        ]);

        // Cookie overlay nur bei Bedarf
        const accepted = getCookie("cookies_accepted") === "yes";
        if(!accepted){
          const overlay = document.getElementById("cookieOverlay");
          overlay.classList.add("is-visible");
          await loadInto(overlay, overlay.dataset.src);
          window.acceptCookies = () => {
            setCookie("cookies_accepted","yes",180);
            overlay.classList.remove("is-visible");
          };
        }

        // Wheel/Touch auf Stage (damit es überall greift)
        const stage = document.getElementById("stage");
        stage.addEventListener("wheel", onWheel, { passive:false });
        stage.addEventListener("touchstart", onTouchStart, { passive:true });
        stage.addEventListener("touchmove", onTouchMove, { passive:false });
        stage.addEventListener("touchend", onTouchEnd, { passive:true });
        stage.addEventListener("touchcancel", onTouchEnd, { passive:true });

        // Shadow an beide Scroller binden
        const hs = getHeadScroller();
        const ss = getShopScroller();
        hs.addEventListener("scroll", updateTitleShadow, { passive:true });
        ss.addEventListener("scroll", updateTitleShadow, { passive:true });

        updateTitleShadow();
      }

      boot().catch(console.error);
    })();
  </script>
</body>
</html>
