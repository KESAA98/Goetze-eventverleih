<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>Eventverleih</title>
  <link rel="icon" type="image/png" href="image/Logo.png" />

  <style>
    :root{
      --cart-width: 360px;
      --title-height: 70px;

      --font-base: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;

      --bg: #ffffff;
      --text: #1f2933;
      --muted: #6b7280;
      --primary: #1f4fa3;

      --card: #f8f9fb;
      --radius: 14px;
      --shadow: 0 12px 40px rgba(0,0,0,.18);

      /* Shadow für Titel-Leiste (nur nach Scroll) */
      --title-shadow: 0 8px 24px rgba(0,0,0,.12);
    }

    html, body{
      margin:0;
      padding:0;
      height:100%;
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-base);
      overflow-x:hidden;
      -webkit-text-size-adjust: 100%;
      text-rendering: optimizeLegibility;
    }

    *, *::before, *::after{ box-sizing: border-box; }

    .slot{
      width:100%;
      border:0;
      outline:0;
      background:transparent;
    }

    /* Cookie-Overlay */
    #cookieOverlay{
      position:fixed;
      inset:0;
      z-index:9999;
      display:none;
      background:transparent;
    }
    #cookieOverlay.is-visible{ display:block; }

    /* TITEL */
    #title{
      position: sticky;
      top: 0;
      z-index: 2000;
      height: var(--title-height);
      background: #fff;
      display: block;
      box-shadow: none;
    }
    #title.is-scrolled{
      box-shadow: var(--title-shadow);
    }

    /* Head: unter der Titel-Leiste, bekommt eine echte Höhe (wichtig für %/Flex in head.html) */
    #head{
      height: calc(100vh - var(--title-height));
      min-height: calc(100vh - var(--title-height));
      overflow: auto;              /* Head kann intern scrollen, falls Inhalt zu hoch */
      overscroll-behavior: contain;
    }

    /* Shop */
    #shop{
      min-height:100vh;
      width:calc(100% - var(--cart-width));
      margin-right:var(--cart-width);
    }

    /* Cart */
    #cart{
      position:fixed;
      top:0;
      right:0;
      height:100vh;
      width:var(--cart-width);
      z-index:50;
      background:transparent;
      pointer-events:none;
      transform: translateX(100%);
      transition: transform .22s ease;
    }

    @media (max-width: 900px){
      :root{ --cart-width: 0px; }
      #cart{ transform:none; }
      #shop{ width:100%; margin-right:0; }
    }
  </style>
</head>

<body>
  <!-- 1) Cookies -->
  <div id="cookieOverlay" class="slot" data-src="backend/cookie.html"></div>

  <!-- 2) Titel -->
  <header id="title" class="slot" data-src="backend/titel.html"></header>

  <!-- 3) Head -->
  <section id="head" class="slot" data-src="backend/head.html"></section>

  <!-- 4) Shop -->
  <main id="shop" class="slot" data-src="backend/shop.html"></main>

  <!-- 5) Cart -->
  <aside id="cart" class="slot" data-src="backend/cart.html"></aside>

  <script>
    (function(){
      const COOKIE_KEY = "cookiesAccepted_v1";

      /* von cookie.html aufrufbar */
      window.acceptCookies = function(){
        try { localStorage.setItem(COOKIE_KEY, "1"); } catch(e) {}
        document.getElementById("cookieOverlay")?.classList.remove("is-visible");
      };

      /* Cart-Steuerung */
      window.openCart = function(){
        const el = document.getElementById("cart");
        if(!el) return;
        el.style.pointerEvents = "auto";
        el.style.transform = "translateX(0)";
      };

      window.closeCart = function(){
        const el = document.getElementById("cart");
        if(!el) return;
        el.style.pointerEvents = "none";
        el.style.transform = "translateX(100%)";
      };

      async function loadInto(el, url){
        const res = await fetch(url, { cache: "no-store" });
        if(!res.ok) throw new Error(url + " -> " + res.status);
        const html = await res.text();

        el.innerHTML = html;

        /* Scripts aus geladenem HTML ausführen */
        const scripts = Array.from(el.querySelectorAll("script"));
        for(const s of scripts){
          const ns = document.createElement("script");
          for(const attr of s.attributes){
            ns.setAttribute(attr.name, attr.value);
          }
          ns.text = s.text || "";
          s.parentNode.replaceChild(ns, s);
        }
      }

      function setupTitleShadow(){
        const title = document.getElementById("title");
        if(!title) return;

        const update = () => {
          if(window.scrollY > 0) title.classList.add("is-scrolled");
          else title.classList.remove("is-scrolled");
        };

        update();
        window.addEventListener("scroll", update, { passive:true });
      }

      function setupHeadShopScrollSwitch(){
        const head = document.getElementById("head");
        const shop = document.getElementById("shop");
        if(!head || !shop) return;

        const cookieVisible = () => {
          const ov = document.getElementById("cookieOverlay");
          return !!(ov && ov.classList.contains("is-visible"));
        };

        const headScrollable = () => head.scrollHeight > head.clientHeight + 1;
        const headAtBottom = () => head.scrollTop + head.clientHeight >= head.scrollHeight - 1;

        const shopAtTop = () => {
          const r = shop.getBoundingClientRect();
          return r.top >= -1;
        };

        const scrollToShop = () => {
          const y = shop.getBoundingClientRect().top + window.scrollY;
          window.scrollTo({ top: y, behavior: "smooth" });
        };

        const scrollToHead = (toBottom = false) => {
          const y = head.getBoundingClientRect().top + window.scrollY;
          window.scrollTo({ top: y, behavior: "smooth" });
          setTimeout(() => {
            if(headScrollable()){
              head.scrollTop = toBottom ? (head.scrollHeight - head.clientHeight) : 0;
            }else{
              head.scrollTop = 0;
            }
          }, 250);
        };

        // Wheel: Wechsel Head -> Shop (runter), Shop -> Head (hoch)
        window.addEventListener("wheel", (e) => {
          if(cookieVisible()) return;

          const down = e.deltaY > 0;
          const up   = e.deltaY < 0;

          const inHeadView = shop.getBoundingClientRect().top > 1;

          if(down && inHeadView){
            if(headScrollable()){
              if(headAtBottom()){
                e.preventDefault();
                scrollToShop();
              }
            }else{
              e.preventDefault();
              scrollToShop();
            }
          }

          if(up && shopAtTop()){
            e.preventDefault();
            scrollToHead(true);
          }
        }, { passive:false });

        // Tastatur
        window.addEventListener("keydown", (e) => {
          if(cookieVisible()) return;

          const downKeys = ["ArrowDown","PageDown"," "];
          const upKeys   = ["ArrowUp","PageUp"];

          const isDown = downKeys.includes(e.key);
          const isUp   = upKeys.includes(e.key);

          const inHeadView = shop.getBoundingClientRect().top > 1;

          if(isDown && inHeadView){
            if(headScrollable()){
              if(headAtBottom()){
                e.preventDefault();
                scrollToShop();
              }
            }else{
              e.preventDefault();
              scrollToShop();
            }
          }

          if(isUp && shopAtTop()){
            e.preventDefault();
            scrollToHead(true);
          }
        }, { passive:false });
      }

      async function boot(){
        const slots = Array.from(document.querySelectorAll("[data-src]"));

        let accepted = false;
        try { accepted = localStorage.getItem(COOKIE_KEY) === "1"; } catch(e) {}

        /* Titel / Head / Shop / Cart immer laden */
        const normalSlots = slots.filter(el => el.id !== "cookieOverlay");
        await Promise.all(normalSlots.map(el => loadInto(el, el.dataset.src)));

        /* Cookie nur bei Bedarf */
        if(!accepted){
          const overlay = document.getElementById("cookieOverlay");
          overlay.classList.add("is-visible");
          await loadInto(overlay, overlay.dataset.src);
        }

        setupTitleShadow();
        setupHeadShopScrollSwitch();
      }

      boot().catch(err => console.error(err));
    })();
  </script>
</body>
</html>
