<!-- backend/head.html -->
<style>
  :root{
    --title-pad-x: 72px;
    --logo-pad-left: 32px;
    --nav-pad-right: 32px;

    --edge-left:  calc(var(--title-pad-x) + var(--logo-pad-left));
    --edge-right: calc(var(--title-pad-x) + var(--nav-pad-right));

    --head-gap: 34px;

    --radius: 18px;
    --shadow-soft: 0 12px 34px rgba(0,0,0,.14);

    /* Blau-Tint (#0F172A) */
    --hero-blue-a1: .75;
    --hero-blue-a2: .62;
    --hero-blue-a3: .45;

    /* Mosaic */
    --mosaic-gap: 12px;
    --tile-radius: 16px;

    /* Fade (statt mask, damit Schatten nicht abgeschnitten wird) */
    --fadeW: 64px;
  }

  .head-wrap{
    width:100%;
    padding-left:  var(--edge-left);
    padding-right: var(--edge-right);
    padding-top:   var(--head-gap);
    padding-bottom:var(--head-gap);
  }

  .hero{
    width:100%;
    height:52vh;
    min-height:360px;
    max-height:620px;
    border-radius: var(--radius);
    overflow:hidden;
    position:relative;
    background:#d9dde3;
    box-shadow: var(--shadow-soft);
  }
  .hero__bg{
    position:absolute; inset:0;
    background-size:cover;
    background-position:center;
    transform: scale(1.02);
    filter: saturate(.92) contrast(.95);
  }
  .hero__tint{
    position:absolute; inset:0;
    background: linear-gradient(
      135deg,
      rgba(15, 23, 42, var(--hero-blue-a1)) 0%,
      rgba(15, 23, 42, var(--hero-blue-a2)) 52%,
      rgba(15, 23, 42, var(--hero-blue-a3)) 100%
    );
    mix-blend-mode: multiply;
  }
  .hero__dim{
    position:absolute; inset:0;
    background: rgba(0,0,0,.12);
  }

  /* =========================
     Mosaic Strip (ohne äußeren Kasten)
     Fixes:
     - KEIN transparenter Übergang per mask -> stattdessen Overlay-Fade
     - Schatten wird nicht abgeschnitten (overflow sichtbar + Innenpadding)
     - Bilder wirken nicht „zu breit“ -> contain statt cover
     ========================= */
  .mosaic-wrap{
    margin-top: var(--head-gap);

    height:25vh;
    min-height:170px;
    max-height:240px;

    background: transparent;
    position:relative;

    /* Platz für Schatten */
    padding: 8px 0 14px;
    overflow: visible;
  }

  .mosaic{
    width:100%;
    height:100%;

    display:grid;
    grid-template-columns: repeat(48, minmax(0, 1fr));
    grid-template-rows: repeat(8, minmax(0, 1fr));
    gap: var(--mosaic-gap);

    /* wichtig: Schatten nicht kappen */
    overflow: visible;
  }

  /* Seiten-Fade als Overlay (nicht transparent, nicht „ausmaskieren“) */
  .mosaic-wrap::before,
  .mosaic-wrap::after{
    content:"";
    position:absolute;
    top: 8px;
    bottom: 14px;
    width: var(--fadeW);
    pointer-events:none;
    z-index: 5;
  }
  .mosaic-wrap::before{
    left: 0;
    background: linear-gradient(90deg, rgba(255,255,255,1) 0%, rgba(255,255,255,0) 100%);
  }
  .mosaic-wrap::after{
    right: 0;
    background: linear-gradient(270deg, rgba(255,255,255,1) 0%, rgba(255,255,255,0) 100%);
  }

  .m-tile{
    position:relative;
    border-radius: var(--tile-radius);
    overflow:hidden;

    background: #f3f5f9; /* „Letterbox“-Hintergrund für contain */
    box-shadow: 0 10px 26px rgba(0,0,0,.12);
    transform: translateZ(0);
  }

  .m-tile img{
    width:100%;
    height:100%;
    display:block;

    /* zeigt ganze Produkte / Hochformatbilder komplett */
    object-fit: contain;
    object-position: center;

    padding: 6px; /* etwas Luft, wirkt „Katalog“ statt abgeschnitten */
    transition: transform .22s ease, filter .22s ease;
    filter: saturate(.96) contrast(.99);
  }

  .m-tile:hover img{
    transform: scale(1.03);
    filter: saturate(1) contrast(1);
  }

  /* Smooth Loading */
  .head-wrap.is-loading .hero,
  .head-wrap.is-loading .mosaic-wrap{
    opacity: 0;
    transform: translateY(6px);
  }
  .hero, .mosaic-wrap{
    opacity: 1;
    transform: translateY(0);
    transition: opacity .28s ease, transform .28s ease;
  }

  .head-skeleton{
    display:none;
    margin-top: var(--head-gap);
    height:25vh;
    min-height:170px;
    max-height:240px;
    border-radius: var(--radius);
    background: linear-gradient(90deg, #f2f4f8 0%, #e9edf4 35%, #f2f4f8 70%, #f2f4f8 100%);
    background-size: 220% 100%;
    box-shadow: 0 10px 26px rgba(0,0,0,.08);
    animation: shimmer 1.15s ease-in-out infinite;
  }
  @keyframes shimmer{
    0%{ background-position: 0% 0; }
    100%{ background-position: 100% 0; }
  }
  .head-wrap.is-loading .head-skeleton{ display:block; }

  @media (max-width:700px){
    :root{
      --title-pad-x: 40px;
      --logo-pad-left: 16px;
      --nav-pad-right: 16px;
      --head-gap: 26px;
      --mosaic-gap: 10px;
      --tile-radius: 14px;
      --fadeW: 44px;
    }
    .hero{ height:46vh; min-height:300px; }
  }

  @media (max-width:560px){
    :root{
      --title-pad-x: 22px;
      --logo-pad-left: 10px;
      --nav-pad-right: 10px;
      --head-gap: 22px;
      --mosaic-gap: 8px;
      --tile-radius: 14px;
      --fadeW: 34px;
    }
    .mosaic-wrap{ min-height:150px; max-height:210px; }
    .hero{ min-height:260px; }
  }
</style>

<section class="head-wrap is-loading" id="headWrap" aria-label="Header-Bereich">
  <div class="hero">
    <div class="hero__bg" id="heroBg"></div>
    <div class="hero__tint"></div>
    <div class="hero__dim"></div>
  </div>

  <div class="head-skeleton" aria-hidden="true"></div>

  <div class="mosaic-wrap" aria-label="Zufällige Artikelbilder">
    <div class="mosaic" id="mosaic"></div>
  </div>
</section>

<script>
(async function(){
  const BG_MANIFEST    = "image/hintergrund/manifest.json";
  const ITEMS_MANIFEST = "Items/manifest.json";

  // Neues Template: weniger „super-breit“, mehr ausgewogene Formen.
  // (48x8 vollständig gefüllt, keine Lücken)
  const TEMPLATE_48x8 = [
    {x:0,  y:0, w:12, h:4},   // groß
    {x:12, y:0, w:12, h:4},   // groß
    {x:24, y:0, w:8,  h:4},   // medium
    {x:32, y:0, w:8,  h:2},   // medium
    {x:40, y:0, w:8,  h:2},   // medium
    {x:32, y:2, w:6,  h:2},   // klein
    {x:38, y:2, w:10, h:2},   // medium

    {x:0,  y:4, w:8,  h:4},   // medium
    {x:8,  y:4, w:12, h:4},   // groß
    {x:20, y:4, w:10, h:4},   // medium
    {x:30, y:4, w:6,  h:4},   // hoch/medium
    {x:36, y:4, w:6,  h:2},   // klein
    {x:42, y:4, w:6,  h:2},   // klein
    {x:36, y:6, w:12, h:2},   // medium
  ];

  const load = async (p) => {
    const r = await fetch(p, { cache: "no-store" });
    if(!r.ok) throw new Error(p + " -> " + r.status);
    return await r.json();
  };

  const pick = (a) => a[Math.floor(Math.random() * a.length)];

  function shuffleUnique(arr){
    const uniq = Array.from(new Set(arr));
    for(let i = uniq.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [uniq[i], uniq[j]] = [uniq[j], uniq[i]];
    }
    return uniq;
  }

  function preloadImage(src){
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => resolve(true);
      img.onerror = () => resolve(false);
      img.src = src;
    });
  }

  function renderMosaic(allImages){
    const el = document.getElementById("mosaic");
    if(!el) return [];

    el.innerHTML = "";

    const needed = TEMPLATE_48x8.length;
    const imgs = shuffleUnique(allImages).slice(0, Math.max(needed, 1));

    const used = [];
    TEMPLATE_48x8.forEach((slot, i) => {
      const src = imgs[i % imgs.length];

      const d = document.createElement("div");
      d.className = "m-tile";
      d.style.gridColumn = (slot.x + 1) + " / span " + slot.w;
      d.style.gridRow    = (slot.y + 1) + " / span " + slot.h;

      const img = document.createElement("img");
      img.loading = "eager";
      img.alt = "";
      img.src = src;

      d.appendChild(img);
      el.appendChild(d);

      used.push(src);
    });

    return used;
  }

  const headWrap = document.getElementById("headWrap");

  let heroUrl = null;
  try{
    const bg = await load(BG_MANIFEST);
    if(Array.isArray(bg) && bg.length){
      heroUrl = "image/hintergrund/" + pick(bg);
      document.getElementById("heroBg").style.backgroundImage = "url('" + heroUrl + "')";
    }
  }catch(e){}

  let usedImages = [];
  try{
    const raw = await load(ITEMS_MANIFEST);
    if(Array.isArray(raw) && raw.length){
      usedImages = renderMosaic(raw);
    }
  }catch(e){}

  const preloadList = [];
  if(heroUrl) preloadList.push(preloadImage(heroUrl));
  usedImages.forEach((src) => preloadList.push(preloadImage(src)));

  const timeoutMs = 1100;
  const timeout = new Promise((resolve) => setTimeout(resolve, timeoutMs));

  try{
    await Promise.race([Promise.allSettled(preloadList), timeout]);
  }catch(e){}

  if(headWrap){
    headWrap.classList.remove("is-loading");
  }
})();
</script>
