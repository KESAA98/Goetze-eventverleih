<!-- backend/head.html | Stage passt sich dem #head-Container an (100%), scrollt NUR intern.
     Desktop: Anker-Punkte (Center) für Text/Bild/Auswahl.
     Impuls-Logik: Wenn NICHT scrollbar → Wheel-Down triggert goShop().
                  Wenn scrollbar → erst am Ende "Stop", erst beim nächsten Wheel-Down goShop().
                  Optionaler Button "Zum Shop ↓" erscheint am Ende. -->

<section class="team-head" aria-label="Team">
  <div class="team-head__bg" id="teamBg" aria-hidden="true"></div>
  <div class="team-head__veil" aria-hidden="true"></div>

  <!-- Dieser Wrapper ist die EINZIGE Scroll-Fläche innerhalb head.html -->
  <div class="team-scroll" id="teamScroll" aria-label="Team Inhalt">
    <div class="team-stage">
      <!-- Slider -->
      <div class="team-viewport" aria-label="Team Slider">
        <div class="team-track" id="teamTrack"></div>
      </div>

      <!-- Auswahl (Tabs) -->
      <div class="team-tabsAnchor" aria-label="Team Auswahl">
        <div class="team-tabsWrap">
          <div class="team-tabs" id="teamTabs"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  :root{
    --radius: 18px;

    /* Desktop Anker (Center) */
    --anc-text-x: 40%;
    --anc-text-y: 37.5%;

    --anc-img-x:  80%;
    --anc-img-y:  37.5%;

    --anc-tabs-x: 50%;
    --anc-tabs-y: 87%;

    /* Max Größen inkl. Padding */
    --max-text-w: 60%;
    --max-text-h: 75%;

    --max-img-w:  40%;
    --max-img-h:  75%;

    --max-tabs-w: 100%;
    --max-tabs-h: 25%;

    --shadow-soft: 0 18px 50px rgba(0,0,0,0.12);
  }

  .team-head{
    position:relative;
    width:100%;
    height:100%;          /* <<< passt sich #head an */
    overflow:hidden;      /* <<< nix nach außen */
    background:#d9dde3;
  }

  .team-head__bg{
    position:absolute; inset:0;
    background-size:cover;
    background-position:center;
    transform:scale(1.05);
    filter:saturate(.98) contrast(.98);
  }

  .team-head__veil{
    position:absolute; inset:0;
    background:
      radial-gradient(1200px 700px at 18% 40%, rgba(255,255,255,0.86), rgba(255,255,255,0.18) 58%, rgba(255,255,255,0.0) 74%),
      linear-gradient(90deg, rgba(255,255,255,0.92) 0%, rgba(255,255,255,0.70) 40%, rgba(255,255,255,0.22) 70%, rgba(255,255,255,0.10) 100%);
    backdrop-filter: blur(10px);
  }

  /* ===== interner Scroll-Container (nur hier) ===== */
  .team-scroll{
    position:relative;
    z-index:1;
    height:100%;
    width:100%;
    overflow:auto;                 /* <<< nur innen scrollen */
    overscroll-behavior: contain;
    -webkit-overflow-scrolling: touch;

    padding: 18px 24px;
  }

  /* Scrollbar verstecken (Scroll bleibt aktiv) */
  .team-scroll{ scrollbar-width:none; }
  .team-scroll::-webkit-scrollbar{ width:0; height:0; }

  /* ===== Bühne ===== */
  .team-stage{
    position:relative;
    width:100%;
    height:100%;
    min-height: 520px; /* Sicherheit, falls Head sehr klein */
  }

  /* ===== Slider ===== */
  .team-viewport{
    position:relative;
    width:100%;
    height:100%;
    overflow:hidden;
    border-radius: var(--radius);
  }

  .team-track{
    height:100%;
    display:flex;
    width:100%;
    transform: translateX(0%);
    transition: transform .55s cubic-bezier(.22,.9,.18,1);
    will-change: transform;
  }

  .team-slide{
    position:relative;
    flex: 0 0 100%;
    height:100%;
  }

  /* ===== Cards (absolut über Anker) ===== */
  .card{
    position:absolute;
    transform: translate(-50%, -50%);
    border-radius: var(--radius);
  }

  /* Textcard (links) */
  .card--text{
    left: var(--anc-text-x);
    top:  var(--anc-text-y);

    width: min(var(--max-text-w), 860px);
    max-height: var(--max-text-h);

    background: rgba(255,255,255,0.84);
    border: 1px solid rgba(15,23,42,0.10);
    box-shadow: var(--shadow-soft);
    backdrop-filter: blur(10px);

    padding: 22px 22px 18px;
    overflow:hidden;
  }

  .team-title{
    margin:0 0 10px 0;
    font-size: clamp(24px, 2.2vw, 40px);
    line-height:1.02;
    letter-spacing:-0.02em;
    color:#0f172a;
  }

  .team-text{
    font-size: clamp(14px, 1.0vw, 16px);
    line-height:1.65;
    color: rgba(15,23,42,0.78);
    white-space: pre-wrap;
  }

  /* CTA erscheint nur wenn am Ende */
  .team-ctaRow{
    margin-top: 14px;
    display:none;
    justify-content:flex-end;
  }
  .team-ctaRow.is-visible{ display:flex; }

  .team-cta{
    display:inline-flex;
    align-items:center;
    gap: 10px;
    padding: 10px 14px;
    border-radius: 999px;
    cursor:pointer;
    user-select:none;

    background: rgba(31,79,163,0.12);
    border: 1px solid rgba(31,79,163,0.28);
    color:#0f172a;
    font-weight: 800;
    letter-spacing:-0.01em;

    transition: transform .12s ease, background .12s ease;
  }
  .team-cta:hover{ background: rgba(31,79,163,0.18); }
  .team-cta:active{ transform: scale(0.98); }

  /* Bildcard (rechts) */
  .card--image{
    left: var(--anc-img-x);
    top:  var(--anc-img-y);

    width: min(var(--max-img-w), 520px);
    max-height: var(--max-img-h);

    display:flex;
    align-items:center;
    justify-content:center;
    pointer-events:none; /* rein dekorativ */
  }

  .team-portrait{
    width: 100%;
    aspect-ratio: 1 / 1;
    border-radius: 999px;
    overflow:hidden;
    background: rgba(255,255,255,0.55);
    border: 1px solid rgba(15,23,42,0.10);
    box-shadow: 0 22px 60px rgba(0,0,0,0.18);
    backdrop-filter: blur(8px);
  }
  .team-portrait img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
    transform: scale(1.02);
  }

  /* ===== Tabs (Auswahl) ===== */
  .team-tabsAnchor{
    position:absolute;
    left: var(--anc-tabs-x);
    top:  var(--anc-tabs-y);
    transform: translate(-50%, -50%);
    width: min(var(--max-tabs-w), 1200px);
    max-height: var(--max-tabs-h);
    display:flex;
    justify-content:center;
    align-items:flex-start;
    pointer-events:auto;
  }

  .team-tabsWrap{
    width:100%;
    display:flex;
    justify-content:center;
    padding: 6px 8px;
    border-radius: 999px;
    background: rgba(255,255,255,0.40);
    border: 1px solid rgba(15,23,42,0.10);
    backdrop-filter: blur(10px);
  }

  .team-tabs{
    display:flex;
    gap: 12px;
    align-items:center;
    justify-content:center;
    width:100%;
    overflow:hidden;
  }

  .team-tab{
    display:flex;
    align-items:center;
    gap: 10px;
    padding: 10px 14px;
    border-radius: 999px;
    background: rgba(255,255,255,0.62);
    border: 1px solid rgba(15,23,42,0.12);
    cursor:pointer;
    user-select:none;
    transition: background .14s ease, border-color .14s ease, transform .14s ease;
    white-space:nowrap;
    flex: 0 0 auto;
  }
  .team-tab:hover{
    background: rgba(255,255,255,0.78);
    border-color: rgba(31,79,163,0.22);
    transform: translateY(-1px);
  }
  .team-tab.is-active{
    background: rgba(255,255,255,0.92);
    border-color: rgba(15,23,42,0.20);
  }

  .team-tab__avatar{
    width: 30px;
    height: 30px;
    border-radius: 999px;
    overflow:hidden;
    background:#e9eef7;
    border: 1px solid rgba(15,23,42,0.10);
    flex: 0 0 auto;
  }
  .team-tab__avatar img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }
  .team-tab__name{
    font-weight: 760;
    color:#0f172a;
    letter-spacing:-0.01em;
  }

  /* ===== Mobile: untereinander (Bild -> Auswahl -> Text) ===== */
  @media (max-width: 980px){
    .team-scroll{
      padding: 14px 14px 18px;
    }

    .team-stage{
      min-height: 0;
      height: auto;     /* untereinander fließen */
    }

    .team-viewport{
      height: auto;
      overflow: visible;
      border-radius: 16px;
    }

    .team-track{
      height: auto;
    }

    .team-slide{
      height: auto;
      padding-bottom: 14px;
    }

    /* Karten werden statisch, damit sie untereinander stehen */
    .card{
      position:static;
      transform:none;
      border-radius: 16px;
    }

    /* Reihenfolge: Bild, Tabs, Text */
    .card--image{ width:100%; max-height:none; margin-bottom: 12px; }
    .team-portrait{ width: min(280px, 70vw); margin: 0 auto; }

    .team-tabsAnchor{
      position:static;
      transform:none;
      width:100%;
      max-height:none;
      margin-bottom: 12px;
    }

    .team-tabs{
      flex-wrap: wrap;
      justify-content:center;
      overflow: visible;
    }

    .card--text{
      width:100%;
      max-height:none;
      padding: 18px 18px 14px;
    }
  }
</style>

<script>
  (function(){
    const BG_MANIFEST_URL   = "image/hintergrund/manifest.json";
    const TEAM_MANIFEST_URL = "Team/manifest.json";

    const bgEl    = document.getElementById("teamBg");
    const trackEl = document.getElementById("teamTrack");
    const tabsEl  = document.getElementById("teamTabs");
    const scrollEl= document.getElementById("teamScroll");

    let members = [];
    let active = 0;

    // Impuls-Handling
    let downArmed = false;
    let downCooldown = false;

    function parseFolder(folder){
      const parts = String(folder).split("_");
      let pos = null;
      if (parts.length > 1) {
        const last = parts[parts.length - 1];
        const n = Number(last);
        if (Number.isFinite(n)) { pos = n; parts.pop(); }
      }
      const name = parts.join(" ").trim() || folder;
      return { name, pos };
    }

    function splitFirstSentence(text){
      const t = (text || "").trim();
      if (!t) return {
        first: "Schön, dass du da bist!",
        rest:  "Wir sind LG Eventverleih – ein kleines, engagiertes Team mit einer großen Leidenschaft für besondere Momente."
      };

      const nl = t.indexOf("\n");
      if (nl > 0){
        const first = t.slice(0, nl).trim();
        const rest = t.slice(nl + 1).trim();
        return { first: first || "Schön, dass du da bist!", rest };
      }

      const m = t.match(/^[\s\S]*?[.!?](?:\s|$)/);
      if (m && m[0]){
        const cut = m[0].length;
        const first = t.slice(0, cut).trim();
        const rest = t.slice(cut).trim();
        return { first: first || "Schön, dass du da bist!", rest };
      }

      return { first: t, rest: "" };
    }

    async function fetchJson(url){
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error("Fetch failed: " + url);
      return await r.json();
    }

    async function fetchText(url){
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error("Fetch failed: " + url);
      return await r.text();
    }

    function setRandomBackground(list){
      if (!Array.isArray(list) || list.length === 0) return;
      const pick = list[Math.floor(Math.random() * list.length)];
      bgEl.style.backgroundImage = "url('image/hintergrund/" + String(pick).replace(/'/g, "%27") + "')";
    }

    function setActive(idx){
      active = idx;
      trackEl.style.transform = "translateX(" + (-idx * 100) + "%)";

      tabsEl.querySelectorAll(".team-tab").forEach(el => el.classList.remove("is-active"));
      const btn = tabsEl.querySelector('[data-index="' + idx + '"]');
      if (btn) btn.classList.add("is-active");

      // Impuls-Zustand beim Wechsel zurücksetzen
      downArmed = false;
      downCooldown = false;
      updateCtaVisibility();
    }

    function isScrollable(){
      return scrollEl.scrollHeight > scrollEl.clientHeight + 1;
    }

    function atBottom(){
      return scrollEl.scrollTop + scrollEl.clientHeight >= scrollEl.scrollHeight - 1;
    }

    function triggerDown(){
      if (downCooldown) return;
      downCooldown = true;

      if (typeof window.goShop === "function") window.goShop();

      setTimeout(() => { downCooldown = false; }, 500);
    }

    function updateCtaVisibility(){
      const slide = trackEl.querySelectorAll(".team-slide")[active];
      if (!slide) return;
      const ctaRow = slide.querySelector(".team-ctaRow");
      if (!ctaRow) return;

      // CTA nur, wenn scrollbar UND am Ende
      if (isScrollable() && atBottom()) ctaRow.classList.add("is-visible");
      else ctaRow.classList.remove("is-visible");
    }

    function bindImpulseLogic(){
      if (!scrollEl) return;

      scrollEl.addEventListener("scroll", () => {
        // Wenn scrollbar: am Ende CTA zeigen + downArmed setzen
        if (isScrollable() && atBottom()){
          downArmed = true;
        }else{
          downArmed = false;
        }
        updateCtaVisibility();
      }, { passive:true });

      scrollEl.addEventListener("wheel", (e) => {
        const down = e.deltaY > 0;

        // Fall A: NICHT scrollbar -> erster Down triggert direkt
        if (!isScrollable()){
          if (down){
            e.preventDefault();
            triggerDown();
          }
          return;
        }

        // Fall B: scrollbar
        if (down && atBottom()){
          // "Stop" beim ersten Mal am Ende, erst beim nächsten Wheel-Down
          if (downArmed){
            e.preventDefault();
            triggerDown();
          }else{
            // falls jemand exakt ans Ende wheel't: erstmal nur scharf schalten
            downArmed = true;
          }
        }
      }, { passive:false });
    }

    function makeSlide(member){
      const slide = document.createElement("div");
      slide.className = "team-slide";

      // TEXT (links)
      const textCard = document.createElement("div");
      textCard.className = "card card--text";

      const { first, rest } = splitFirstSentence(member.text);

      const h = document.createElement("h1");
      h.className = "team-title";
      h.textContent = first || "Schön, dass du da bist!";

      const t = document.createElement("div");
      t.className = "team-text";
      t.textContent = (rest && rest.trim().length)
        ? rest
        : "Wir helfen dir, dein Event unkompliziert, stilvoll und zuverlässig auszustatten – damit du dich ganz aufs Feiern konzentrieren kannst.";

      const ctaRow = document.createElement("div");
      ctaRow.className = "team-ctaRow";
      const cta = document.createElement("button");
      cta.type = "button";
      cta.className = "team-cta";
      cta.textContent = "Zum Shop ↓";
      cta.addEventListener("click", () => triggerDown());
      ctaRow.appendChild(cta);

      textCard.appendChild(h);
      textCard.appendChild(t);
      textCard.appendChild(ctaRow);

      // BILD (rechts)
      const imgCard = document.createElement("div");
      imgCard.className = "card card--image";

      const portrait = document.createElement("div");
      portrait.className = "team-portrait";

      const img = document.createElement("img");
      img.loading = "lazy";
      img.src = member.img;
      img.alt = member.name;
      img.onerror = () => {
        img.removeAttribute("src");
        img.alt = "";
      };

      portrait.appendChild(img);
      imgCard.appendChild(portrait);

      slide.appendChild(textCard);
      slide.appendChild(imgCard);

      return slide;
    }

    function makeTab(member, idx){
      const btn = document.createElement("div");
      btn.className = "team-tab";
      btn.tabIndex = 0;
      btn.setAttribute("role", "button");
      btn.dataset.index = String(idx);
      btn.setAttribute("aria-label", "Teammitglied: " + member.name);

      const av = document.createElement("div");
      av.className = "team-tab__avatar";

      const img = document.createElement("img");
      img.loading = "lazy";
      img.src = member.img;
      img.alt = member.name;
      img.onerror = () => {
        av.innerHTML = "";
        const fb = document.createElement("div");
        fb.style.width="100%";
        fb.style.height="100%";
        fb.style.display="grid";
        fb.style.placeItems="center";
        fb.style.fontWeight="900";
        fb.style.color="rgba(15,23,42,0.65)";
        fb.style.background="#e9eef7";
        fb.textContent = member.name.split(" ").map(w => w[0]).slice(0,2).join("").toUpperCase();
        av.appendChild(fb);
      };
      av.appendChild(img);

      const name = document.createElement("div");
      name.className = "team-tab__name";
      name.textContent = member.name;

      btn.appendChild(av);
      btn.appendChild(name);

      const open = () => {
        setActive(idx);
        // Scroll-Position beibehalten, aber CTA updaten
        updateCtaVisibility();
      };

      btn.addEventListener("click", open);
      btn.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") { e.preventDefault(); open(); }
      });

      // “von rechts rein” (stagger)
      btn.style.opacity = "0";
      btn.style.transform = "translateX(18px)";
      requestAnimationFrame(() => {
        btn.style.transition = "opacity .28s ease, transform .28s ease";
        btn.style.transitionDelay = (idx * 45) + "ms";
        btn.style.opacity = "1";
        btn.style.transform = "translateX(0)";
      });

      return btn;
    }

    async function load(){
      try{
        const bg = await fetchJson(BG_MANIFEST_URL);
        setRandomBackground(bg);
      }catch(e){}

      const manifest = await fetchJson(TEAM_MANIFEST_URL);
      const folders = (manifest && Array.isArray(manifest.members))
        ? manifest.members.map(m => m.folder).filter(Boolean)
        : [];

      members = await Promise.all(folders.map(async (folder) => {
        const meta = parseFolder(folder);
        const base = "Team/" + folder + "/";
        const img  = base + "image.png";
        const txt  = base + "team.txt";
        let text = "";
        try{ text = await fetchText(txt); }catch(e){ text = ""; }
        return { folder, name: meta.name, pos: meta.pos, img, text };
      }));

      members.sort((a,b) => {
        const ap = (a.pos == null) ? 9999 : a.pos;
        const bp = (b.pos == null) ? 9999 : b.pos;
        if (ap !== bp) return ap - bp;
        return a.name.localeCompare(b.name, "de");
      });

      trackEl.innerHTML = "";
      tabsEl.innerHTML = "";

      members.forEach((m, i) => {
        trackEl.appendChild(makeSlide(m));
        tabsEl.appendChild(makeTab(m, i));
      });

      if (members.length) setActive(0);

      // initial CTA-State
      updateCtaVisibility();
    }

    bindImpulseLogic();
    load().catch(() => {});
  })();
</script>
