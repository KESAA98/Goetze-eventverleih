<!-- backend/foot.html  (Layout wie Debug: Content nutzt Resthöhe, Footbar feste Höhe; + Overlay Loading/Success/Error) -->

<div class="foot-wrap" id="footRoot">
  <div class="foot-bg" id="footBg" aria-hidden="true"></div>
  <div class="foot-veil" aria-hidden="true"></div>

  <!-- Overlay (Loading / Erfolg / Fehler) -->
  <div class="overlay" id="sendOverlay" aria-hidden="true">
    <div class="overlay__backdrop"></div>
    <div class="overlay__card" role="dialog" aria-modal="true" aria-labelledby="overlayTitle">
      <div class="overlay__top">
        <div class="spinner" id="overlaySpinner" aria-hidden="true"></div>
        <div class="overlay__titles">
          <div class="overlay__title" id="overlayTitle">Nachricht wird gesendet…</div>
          <div class="overlay__sub" id="overlaySub">Bitte einen Moment.</div>
        </div>
      </div>

      <div class="overlay__actions">
        <button class="btn-ghost" id="overlayOk" type="button" style="display:none;">OK</button>
      </div>
    </div>
  </div>

  <div class="foot-layout">
    <div class="foot-content" id="footContent">
      <div class="contact-panel" role="region" aria-label="Kontaktformular">
        <h2 class="contact-title">Sie haben Fragen?</h2>
        <p class="contact-sub">
          Nutzen Sie gerne unser Kontaktfeld – wir melden uns zeitnah auf dem von Ihnen bevorzugten Weg.
        </p>

        <form id="contactForm" class="contact-form" autocomplete="on" novalidate>
          <label class="field">
            <span>Name</span>
            <input id="f_name" name="name" type="text" placeholder="Dein Name" required />
          </label>

          <div class="row">
            <label class="field">
              <span>E-Mail</span>
              <input id="f_email" name="email" type="email" placeholder="name@mail.de" required />
            </label>

            <label class="field">
              <span>Telefon</span>
              <input id="f_phone" name="phone" type="tel" placeholder="+49 …" />
            </label>
          </div>

          <label class="field">
            <span>Nachricht</span>
            <textarea id="f_msg" name="message" placeholder="Wie können wir Ihnen weiterhelfen?" required></textarea>
          </label>

          <div class="pref" role="group" aria-label="Bevorzugter Kontaktweg">
            <div class="pref-label">Wie möchten Sie kontaktiert werden?</div>

            <div class="pref-options">
              <label class="pref-pill" tabindex="0">
                <input type="radio" name="preferenz" value="Telefon" />
                <span>Telefon</span>
              </label>

              <label class="pref-pill" tabindex="0">
                <input type="radio" name="preferenz" value="E-Mail" checked />
                <span>E-Mail</span>
              </label>

              <label class="pref-pill" tabindex="0">
                <input type="radio" name="preferenz" value="WhatsApp" />
                <span>WhatsApp</span>
              </label>
            </div>
          </div>

          <label class="consent">
            <input id="f_consent" type="checkbox" required />
            <span>
              Ich habe die <a data-page="datenschutz" href="#">Datenschutzerklärung</a> gelesen und akzeptiere die
              <a data-page="agb" href="#">AGB</a>.
            </span>
          </label>

          <div class="actions">
            <button class="btn-primary" id="btnSend" type="submit">
              <span class="btn-primary__label">Anfrage senden</span>
            </button>
            <span id="status" class="status" aria-live="polite"></span>
          </div>
        </form>
      </div>
    </div>

    <div class="titlebar" id="footTitlebar" role="contentinfo" aria-label="Fußzeile">
      <div class="titlebar__left titlebar__left--empty" aria-hidden="true"></div>
      <nav class="titlebar__nav" aria-label="Fußnavigation">
        <a class="titlebar__link" data-page="impressum" href="#">Impressum</a>
      </nav>
    </div>
  </div>
</div>

<style>
  :root{
    --footbar-height: 70px;

    --title-pad-x: 72px;
    --logo-pad-left: 32px;
    --nav-pad-right: 32px;

    --radius: 16px;
    --panel-bg: rgba(255,255,255,0.84);
    --panel-border: rgba(15,23,42,0.10);
    --panel-shadow: 0 18px 50px rgba(0,0,0,0.12);

    --text: #0f172a;
    --muted: rgba(15,23,42,0.72);

    --primary: #1f4fa3;
    --primary-2:#2b66d8;
    --primary-3:#173f84;

    --stage-pad: 18px;
    --textarea-h: 140px;
  }

  .foot-wrap, .foot-wrap *{ box-sizing:border-box; }

  .foot-wrap{
    position:relative;
    width:100%;
    height:100%;
    overflow:hidden;
    background:#d9dde3;
  }

  .foot-bg{
    position:absolute; inset:0;
    background-size:cover;
    background-position:center;
    transform: scale(1.05);
    filter: saturate(.98) contrast(.98);
    z-index:0;
  }
  .foot-veil{
    position:absolute; inset:0;
    background:
      radial-gradient(1200px 700px at 18% 40%, rgba(255,255,255,0.86), rgba(255,255,255,0.18) 58%, rgba(255,255,255,0.0) 74%),
      linear-gradient(90deg, rgba(255,255,255,0.92) 0%, rgba(255,255,255,0.70) 40%, rgba(255,255,255,0.22) 70%, rgba(255,255,255,0.10) 100%);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    z-index:0;
  }

  /* ===== Layout wie Debug ===== */
  .foot-layout{
    position:relative;
    z-index:1;
    height:100%;
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }

  .foot-content{
    flex: 1 1 auto;
    min-height: 0;

    display:flex;
    align-items:center;
    justify-content:center;

    padding: var(--stage-pad) 24px 0;
    overflow:hidden;
  }

  .contact-panel{
    width: min(820px, 100%);
    background: var(--panel-bg);
    border: 1px solid var(--panel-border);
    border-radius: var(--radius);
    box-shadow: var(--panel-shadow);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);

    max-height: 100%;
    overflow: hidden;

    padding: 22px 22px 18px;
    display:flex;
    flex-direction:column;
    min-height:0;

    margin-bottom: 14px;
  }

  .contact-title{
    margin:0 0 8px 0;
    font-size: clamp(24px, 2.2vw, 40px);
    line-height:1.05;
    letter-spacing:-0.02em;
    color: var(--text);
  }
  .contact-sub{
    margin:0 0 16px 0;
    color: var(--muted);
    line-height:1.55;
    font-size: 14.5px;
  }

  .contact-form{
    display:flex;
    flex-direction:column;
    gap: 12px;
    min-height:0;
  }

  .field{ display:flex; flex-direction:column; gap:6px; }
  .field > span{
    color: rgba(15,23,42,0.68);
    font-size: 12.5px;
    font-weight: 760;
    letter-spacing: -0.01em;
  }

  input[type="text"], input[type="email"], input[type="tel"], textarea{
    width:100%;
    padding: 12px 12px;
    border-radius: 12px;
    border: 1px solid rgba(15,23,42,0.14);
    background: rgba(255,255,255,0.72);
    color: var(--text);
    outline:none;
    font: 600 14px/1.2 system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  }

  textarea{
    height: var(--textarea-h);
    min-height: var(--textarea-h);
    max-height: var(--textarea-h);
    resize: none;
    overflow:hidden;
    line-height: 1.35;
  }

  input::placeholder, textarea::placeholder{ color: rgba(15,23,42,0.40); }
  input:focus, textarea:focus{
    border-color: rgba(31,79,163,0.30);
    box-shadow: 0 0 0 4px rgba(31,79,163,0.12);
  }

  .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }

  .pref{ margin-top:2px; padding-top:6px; }
  .pref-label{
    color: rgba(15,23,42,0.68);
    font-size: 12.5px;
    font-weight: 860;
    letter-spacing: -0.01em;
    margin-bottom: 8px;
  }
  .pref-options{ display:flex; gap:10px; flex-wrap:wrap; }

  .pref-pill{
    position:relative;
    display:inline-flex;
    align-items:center;
    padding: 10px 14px;
    border-radius: 999px;
    background: rgba(255,255,255,0.62);
    border: 1px solid rgba(15,23,42,0.12);
    cursor:pointer;
    user-select:none;
    transition: background .14s ease, border-color .14s ease, transform .14s ease, box-shadow .14s ease;
    white-space:nowrap;
    outline:none;
  }
  .pref-pill:hover{
    background: rgba(255,255,255,0.78);
    border-color: rgba(31,79,163,0.22);
    transform: translateY(-1px);
  }
  .pref-pill:focus-visible{
    box-shadow: 0 0 0 4px rgba(31,79,163,0.16);
    border-color: rgba(31,79,163,0.34);
  }
  .pref-pill input{ position:absolute; opacity:0; pointer-events:none; }
  .pref-pill span{
    color: var(--text);
    font-weight: 860;
    letter-spacing: -0.01em;
    font-size: 13.5px;
  }
  .pref-pill:has(input:checked){
    background: rgba(31,79,163,0.12);
    border-color: rgba(31,79,163,0.55);
    box-shadow: 0 10px 22px rgba(31,79,163,0.14);
  }
  .pref-pill:has(input:checked) span{
    color: var(--primary);
  }
  /* Fallback-Klasse (falls :has irgendwo zickt) */
  .pref-pill.is-active{
    background: rgba(31,79,163,0.12);
    border-color: rgba(31,79,163,0.55);
    box-shadow: 0 10px 22px rgba(31,79,163,0.14);
  }
  .pref-pill.is-active span{ color: var(--primary); }

  .consent{
    display:flex;
    gap: 10px;
    align-items:flex-start;
    padding-top: 2px;
    color: rgba(15,23,42,0.72);
    font-size: 12.5px;
    line-height: 1.45;
  }
  .consent input{ margin-top:3px; accent-color: var(--primary); }
  .consent a{ color: var(--primary); text-decoration:none; font-weight:860; }
  .consent a:hover{ text-decoration: underline; }

  .actions{ display:flex; align-items:center; gap:12px; flex-wrap:wrap; padding-top:4px; }

  /* Besserer Button */
  .btn-primary{
    border: 1px solid rgba(255,255,255,0.18);
    padding: 12px 16px;
    border-radius: 12px;
    background: linear-gradient(180deg, var(--primary-2) 0%, var(--primary) 100%);
    color:#fff;
    font-weight: 900;
    letter-spacing: .2px;
    box-shadow: 0 14px 28px rgba(31,79,163,0.22);
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    gap:10px;
    transition: transform .14s ease, box-shadow .14s ease, filter .14s ease;
  }
  .btn-primary:hover{
    transform: translateY(-1px);
    box-shadow: 0 18px 34px rgba(31,79,163,0.26);
    filter: saturate(1.02);
  }
  .btn-primary:active{ transform: translateY(0px); }
  .btn-primary:focus-visible{
    outline:none;
    box-shadow: 0 0 0 4px rgba(31,79,163,0.18), 0 18px 34px rgba(31,79,163,0.24);
  }

  /* Deaktiviert via Validierung */
  .contact-form:has(#f_name:invalid) .btn-primary,
  .contact-form:has(#f_email:invalid) .btn-primary,
  .contact-form:has(#f_msg:invalid) .btn-primary,
  .contact-form:has(#f_consent:not(:checked)) .btn-primary{
    background: rgba(15,23,42,0.18);
    color: rgba(15,23,42,0.55);
    box-shadow:none;
    pointer-events:none;
    cursor: default;
    border-color: transparent;
    transform:none;
  }

  /* Fallback (wenn :has nicht greift) -> wird per JS gesetzt */
  .btn-primary.is-disabled{
    background: rgba(15,23,42,0.18);
    color: rgba(15,23,42,0.55);
    box-shadow:none;
    pointer-events:none;
    cursor: default;
    border-color: transparent;
    transform:none;
  }

  .status{ font-size:13px; color: rgba(15,23,42,0.70); font-weight:650; min-height: 18px; }

  /* ===== Footbar (hart fixiert) ===== */
  .titlebar{
    flex: 0 0 var(--footbar-height) !important;
    height: var(--footbar-height) !important;
    min-height: var(--footbar-height) !important;

    display:flex !important;
    align-items:center !important;
    justify-content:space-between !important;

    background:#fff;
    padding: 0 var(--title-pad-x) !important;
    margin: 0 !important;

    border-top: 1px solid rgba(0,0,0,.08);
    line-height: 1 !important;
    overflow: hidden;
  }

  .titlebar__left{
    display:flex !important;
    align-items:center !important;
    padding-left: var(--logo-pad-left) !important;
    min-width:0;
    margin:0 !important;
    line-height:1 !important;
  }
  .titlebar__nav{
    display:flex !important;
    align-items:center !important;
    gap: 34px;
    padding-right: var(--nav-pad-right) !important;
    white-space:nowrap;
    margin:0 !important;
    line-height:1 !important;
  }
  .titlebar__link{
    color:#5b6472;
    text-decoration:none;
    font-size:14px;
    letter-spacing:.2px;

    background:transparent;
    border:0;

    padding: 0 !important;
    margin:0 !important;

    cursor:pointer;
    user-select:none;
    -webkit-tap-highlight-color: transparent;
    outline: none;

    display:inline-flex;
    align-items:center;
    height: 100%;
    line-height:1 !important;
  }
  .titlebar__link:hover{ color:#1f2933; }
  .titlebar__left--empty{ padding-left:0 !important; width:1px; }

  /* ===== Overlay ===== */
  .overlay{
    position:absolute;
    inset:0;
    z-index: 9999;
    display:none;
  }
  .overlay.is-open{ display:block; }
  .overlay__backdrop{
    position:absolute; inset:0;
    background: rgba(15,23,42,0.26);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
  }
  .overlay__card{
    position:absolute;
    left:50%;
    top:50%;
    transform: translate(-50%, -50%);
    width: min(520px, calc(100% - 28px));
    background: rgba(255,255,255,0.92);
    border: 1px solid rgba(15,23,42,0.12);
    border-radius: 16px;
    box-shadow: 0 22px 60px rgba(0,0,0,0.22);
    padding: 18px 18px 14px;
  }
  .overlay__top{
    display:flex;
    gap: 14px;
    align-items:flex-start;
  }
  .overlay__titles{ min-width:0; }
  .overlay__title{
    font-weight: 900;
    color: var(--text);
    letter-spacing: -0.01em;
    font-size: 16px;
    margin-top: 2px;
  }
  .overlay__sub{
    margin-top: 6px;
    color: rgba(15,23,42,0.72);
    line-height: 1.45;
    font-weight: 650;
    font-size: 13.5px;
  }
  .overlay__actions{
    display:flex;
    justify-content:flex-end;
    padding-top: 12px;
  }
  .btn-ghost{
    border: 1px solid rgba(15,23,42,0.14);
    background: rgba(255,255,255,0.74);
    color: rgba(15,23,42,0.86);
    padding: 10px 14px;
    border-radius: 12px;
    font-weight: 850;
    cursor:pointer;
  }
  .btn-ghost:hover{
    background: rgba(255,255,255,0.90);
    border-color: rgba(15,23,42,0.20);
  }

  .spinner{
    width: 34px;
    height: 34px;
    border-radius: 999px;
    border: 3px solid rgba(15,23,42,0.16);
    border-top-color: rgba(31,79,163,0.88);
    animation: spin 0.9s linear infinite;
    margin-top: 2px;
    flex: 0 0 auto;
  }
  @keyframes spin{ to{ transform: rotate(360deg); } }

  /* Mobile */
  @media (max-width:700px){
    :root{
      --title-pad-x: 12px;
      --logo-pad-left: 10px;
      --nav-pad-right: 10px;
      --textarea-h: 160px;
    }

    .row{ grid-template-columns: 1fr; }

    .foot-content{
      align-items:flex-start;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      padding: 14px 14px 0;
    }
    .foot-content::-webkit-scrollbar{ width:0; height:0; }

    textarea{
      height: var(--textarea-h);
      min-height: var(--textarea-h);
      max-height: var(--textarea-h);
      overflow:auto;
    }

    .titlebar__nav{ gap: 14px; }
    .titlebar__link{
      font-size: 13px;
      padding: 0 !important;
    }
    .titlebar__link:active{ background: rgba(0,0,0,.05); }
  }
</style>

<script>
(function(){
  const FLOW_URL = "https://default91b0e232846941aab7d1176f14ecb7.8c.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/6d6aba3378db4ea1bd72aeddae7b9c3b/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=UC1H-XcsNqqsISufNQcfHdXRdkwmgELEKJ8ZDB0lvYg";
  const BG_MANIFEST_URL = "image/hintergrund/manifest.json";

  const wrap = document.getElementById("footRoot");
  const bgEl = document.getElementById("footBg");
  const content = document.getElementById("footContent");
  const panel = wrap ? wrap.querySelector(".contact-panel") : null;
  const ta = document.getElementById("f_msg");

  const overlay = document.getElementById("sendOverlay");
  const overlayTitle = document.getElementById("overlayTitle");
  const overlaySub = document.getElementById("overlaySub");
  const overlaySpinner = document.getElementById("overlaySpinner");
  const overlayOk = document.getElementById("overlayOk");

  function showOverlay(state, title, sub){
    overlay.classList.add("is-open");
    overlay.setAttribute("aria-hidden", "false");

    overlayTitle.textContent = title || "";
    overlaySub.textContent = sub || "";

    if (state === "loading"){
      overlaySpinner.style.display = "";
      overlayOk.style.display = "none";
    } else {
      overlaySpinner.style.display = "none";
      overlayOk.style.display = "";
    }
  }

  function hideOverlay(){
    overlay.classList.remove("is-open");
    overlay.setAttribute("aria-hidden", "true");
  }

  overlayOk.addEventListener("click", hideOverlay);

  function basePath(){
    const host = (location.hostname || "").toLowerCase();
    if (host.endsWith("github.io")) {
      const seg = (location.pathname || "/").split("/").filter(Boolean)[0];
      return seg ? ("/" + seg) : "";
    }
    return "";
  }
  function setNavLinks(root){
    const base = basePath();
    (root || document).querySelectorAll("[data-page]").forEach(a => {
      const page = a.getAttribute("data-page");
      a.setAttribute("href", base + "/" + page + "/");
    });
  }

  async function fetchJson(url){
    const r = await fetch(url, { cache: "no-store" });
    if(!r.ok) throw new Error("Fetch failed: " + url);
    return await r.json();
  }
  function setRandomBackground(list){
    if (!Array.isArray(list) || list.length === 0) return;
    const pick = list[Math.floor(Math.random() * list.length)];
    bgEl.style.backgroundImage = "url('image/hintergrund/" + String(pick).replace(/'/g, "%27") + "')";
  }

  function isMobile(){
    return window.matchMedia && window.matchMedia("(max-width:700px)").matches;
  }

  // Desktop: Textarea so klein wie nötig, damit Panel ohne Scroll in Content passt.
  function fitDesktopTextarea(){
    if (!wrap || !content || !panel || !ta) return;
    if (isMobile()) return;

    content.style.overflow = "hidden";

    const minH = 90;
    const maxH = 180;

    const fits = () => panel.scrollHeight <= content.clientHeight + 1;

    let h = maxH;
    document.documentElement.style.setProperty("--textarea-h", h + "px");

    if (!fits()){
      for (let i = 0; i < 80; i++){
        h -= 4;
        if (h <= minH){ h = minH; break; }
        document.documentElement.style.setProperty("--textarea-h", h + "px");
        if (fits()) break;
      }
    }
  }

  // Extremfall: Wenn selbst mit minimaler Textarea nicht passt -> Content darf scrollen
  function enableScrollIfNeeded(){
    if (!wrap || !content || !panel || !ta) return;
    if (isMobile()) return;

    const minH = 90;
    document.documentElement.style.setProperty("--textarea-h", minH + "px");

    if (panel.scrollHeight > content.clientHeight + 2){
      content.style.overflow = "auto";
      content.style.scrollbarWidth = "none";
      content.style.webkitOverflowScrolling = "touch";
              content.style.msOverflowStyle = "none";
    }else{
      content.style.overflow = "hidden";
    }
  }

  function syncPrefActive(){
    const pills = document.querySelectorAll(".pref-pill");
    pills.forEach(p => p.classList.remove("is-active"));
    const checked = document.querySelector('.pref-pill input[name="preferenz"]:checked');
    if (checked){
      const pill = checked.closest(".pref-pill");
      if (pill) pill.classList.add("is-active");
    }
  }

  function setButtonDisabled(disabled){
    const btn = document.getElementById("btnSend");
    if (!btn) return;
    btn.classList.toggle("is-disabled", !!disabled);
    btn.disabled = !!disabled;
  }

  function validateFormUI(){
    const form = document.getElementById("contactForm");
    if (!form) return;
    setButtonDisabled(!form.checkValidity());
  }

  // initial
  setNavLinks(document);
  (async function(){
    try{ setRandomBackground(await fetchJson(BG_MANIFEST_URL)); }catch(e){}
  })();

  // Items_Anfrage (JSON im JSON) - extern setzbar
  let itemsAnfrage = null;
  window.setItemsAnfrage = function(obj){ itemsAnfrage = (obj === undefined) ? null : obj; };

  const form = document.getElementById("contactForm");
  const statusEl = document.getElementById("status");
  const setStatus = (m)=> statusEl.textContent = m || "";

  function getPreferenz(){
    const el = form.querySelector('input[name="preferenz"]:checked');
    return el ? el.value : "E-Mail";
  }

  // Preference events
  document.querySelectorAll('.pref-pill input[name="preferenz"]').forEach(r => {
    r.addEventListener("change", syncPrefActive);
  });
  document.querySelectorAll(".pref-pill").forEach(pill => {
    pill.addEventListener("click", () => {
      const r = pill.querySelector('input[type="radio"]');
      if (r){ r.checked = true; r.dispatchEvent(new Event("change", { bubbles:true })); }
    });
    pill.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " "){
        e.preventDefault();
        const r = pill.querySelector('input[type="radio"]');
        if (r){ r.checked = true; r.dispatchEvent(new Event("change", { bubbles:true })); }
      }
    });
  });
  syncPrefActive();

  // Validierung: Buttonstatus live aktualisieren
  ["input","change","keyup","blur"].forEach(evName => {
    form.addEventListener(evName, validateFormUI, { passive:true });
  });
  validateFormUI();

  // Layout Fit
  const doFit = () => { fitDesktopTextarea(); enableScrollIfNeeded(); };
  requestAnimationFrame(doFit);
  setTimeout(doFit, 60);
  window.addEventListener("resize", () => setTimeout(doFit, 80), { passive:true });

  // Robust: JSON oder Text aus Response lesen
  async function readResponse(r){
    const ct = (r.headers.get("content-type") || "").toLowerCase();
    if (ct.includes("application/json")){
      try{ return await r.json(); }catch(e){ return null; }
    }
    const t = await r.text().catch(()=> "");
    if (!t) return null;
    // falls Text trotzdem JSON ist
    try{ return JSON.parse(t); }catch(e){ return { message: t }; }
  }

  form.addEventListener("submit", async (ev) => {
    ev.preventDefault();
    setStatus("");

    if (!form.checkValidity()){
      form.reportValidity();
      validateFormUI();
      return;
    }

    const payload = {
      Name: document.getElementById("f_name").value.trim(),
      Email: document.getElementById("f_email").value.trim(),
      Telefon: document.getElementById("f_phone").value.trim() || "",
      Nachricht: document.getElementById("f_msg").value.trim(),
      Preferenz: getPreferenz(),
      Zustimmung: true,
      Items_Anfrage: itemsAnfrage ?? null,
      Quelle: "foot",
      Timestamp: new Date().toISOString()
    };

    try{
      // Overlay: erst jetzt, und bleibt bis Serverantwort da
      showOverlay("loading", "Nachricht wird gesendet…", "Bitte einen Moment.");
      setButtonDisabled(true);

      const r = await fetch(FLOW_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await readResponse(r);
      const success = !!(data && (data.success === true || data.ok === true));
      const message = (data && typeof data.message === "string" && data.message.trim())
        ? data.message.trim()
        : (r.ok ? "Ihre Nachricht wurde erfolgreich übermittelt." : "Beim Senden ist ein Fehler aufgetreten.");

      if (!r.ok || (data && (data.success === false || data.ok === false))){
        showOverlay("done", "Fehler beim Senden", message);
        setStatus("Fehler.");
        setButtonDisabled(false);
        validateFormUI();
        return;
      }

      // Erfolg
      showOverlay("done", "Erfolgreich gesendet", message);
      setStatus("Gesendet.");

      form.reset();
      const emailRadio = form.querySelector('input[name="preferenz"][value="E-Mail"]');
      if (emailRadio) emailRadio.checked = true;

      itemsAnfrage = null;
      syncPrefActive();
      validateFormUI();

    }catch(err){
      showOverlay("done", "Fehler beim Senden", "Bitte später erneut versuchen.");
      setStatus("Fehler.");
      setButtonDisabled(false);
      validateFormUI();
    }
  });
})();
</script>
